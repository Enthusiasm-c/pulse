<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>JÄGERMEISTER Pulse</title>
  <style>
    /* ===== Reset & Design Tokens ===== */
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--accent:#1a5c2e;--accent2:#0f3d1f;--electric:#00ff88;--fg:#2f3e35;--muted:#5b6d62;--border:#cfd8d3;--bg:#f6f6f6;--chip:#eef6f0;--glass:rgba(255,255,255,0.85);--blur:10px}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0a0a0a;margin:0;padding:0;width:100%;height:100vh;overflow:hidden}
    .phone{width:100%;height:100vh;height:100dvh;background:#fff;display:flex;flex-direction:column;overflow:hidden;position:fixed;top:0;left:0;right:0;bottom:0}
    @media (min-width:768px){.phone{max-width:390px;margin:0 auto;box-shadow:0 0 30px rgba(0,0,0,.4);border-radius:12px;position:relative}}
    @supports(padding:env(safe-area-inset-top)){.phone{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}}

    /* Screens */
    .screen{display:none;flex-direction:column;height:100%}
    .screen.active{display:flex}

    /* Header */
    .header{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;padding:48px 20px 16px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .header h1{font-size:22px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Content */
    .content{flex:1;overflow-y:auto;background:var(--bg);padding-bottom:88px;-webkit-overflow-scrolling:touch}
    @supports(padding:env(safe-area-inset-bottom)){.content{padding-bottom:calc(88px + env(safe-area-inset-bottom))}}

    /* Forms */
    .label{font-size:13px;color:var(--muted);margin-bottom:4px}
    .input,.sel,.date,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff;color:var(--fg);transition:.2s}
    .input:focus,.sel:focus,.date:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(26,92,46,.15)}
    .row{display:flex;gap:10px;margin-bottom:12px}

    /* Buttons */
    .btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;line-height:1.2;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(26,92,46,0.3)}
    .btn:active{transform:scale(.96);filter:brightness(0.9)}
    .btn:before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,0.3);transform:translate(-50%,-50%);transition:width 0.6s,height 0.6s}
    .btn:active:before{width:300px;height:300px}
    .btn:disabled{background:linear-gradient(135deg,#9fb7a9,#8aa396);cursor:not-allowed;color:#f1f4f2}

    /* Role Selection Buttons */
    .role-btn{width:100%;padding:20px;background:#fff;border:2px solid var(--border);border-radius:16px;font-size:16px;cursor:pointer;display:flex;align-items:center;gap:16px;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);margin-bottom:12px;text-align:left}
    .role-btn:hover{border-color:var(--accent);background:var(--chip);transform:translateY(-2px);box-shadow:0 8px 20px rgba(26,92,46,0.15)}
    .role-btn:active{transform:scale(0.98)}
    .role-btn-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0}
    .role-btn-content{flex:1}
    .role-btn-title{font-size:18px;font-weight:800;color:var(--fg);margin-bottom:4px}
    .role-btn-desc{font-size:13px;color:var(--muted);line-height:1.4}

    /* Collapsible Section */
    .collapsible{margin-top:24px;border-top:1px solid var(--border);padding-top:16px}
    .collapsible-header{cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted);font-size:13px;padding:8px;transition:color 0.2s}
    .collapsible-header:hover{color:var(--accent)}
    .collapsible-content{max-height:0;overflow:hidden;transition:max-height 0.3s cubic-bezier(0.4,0,0.2,1),opacity 0.3s;opacity:0}
    .collapsible.open .collapsible-content{max-height:500px;opacity:1;padding-top:16px}
    .collapsible-arrow{transition:transform 0.3s}
    .collapsible.open .collapsible-arrow{transform:rotate(180deg)}

    /* Advanced Filters */
    .filter-section{padding:12px;background:#fff;border-bottom:1px solid #e0e0e0}
    .filter-row{display:flex;gap:10px;margin-bottom:10px}
    .filter-col{flex:1}
    .filter-label{font-size:11px;color:var(--muted);margin-bottom:4px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}

    /* Settings Redesign */
    .settings-section{background:#fff;border-radius:16px;margin:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    .settings-section-title{font-size:14px;font-weight:700;color:var(--accent);margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .settings-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f5f5f5}
    .settings-row:last-child{border-bottom:none}
    .settings-label{font-size:13px;color:var(--muted);font-weight:500}
    .settings-value{font-size:13px;font-weight:600;color:var(--fg)}
    .settings-input{flex:1;max-width:200px;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px}
    .settings-divider{height:1px;background:var(--border);margin:20px 0}
    .settings-footer{padding:16px;background:#f9f9f9;margin:-16px;margin-top:20px;border-radius:0 0 16px 16px}
    .btn-icon-gradient{background:linear-gradient(135deg,var(--accent),var(--electric));padding:12px 20px;border-radius:10px;font-size:14px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,255,136,0.2)}
    .btn-signout{background:linear-gradient(135deg,#dc2626,#b91c1c);width:100%;justify-content:center;font-size:14px;padding:12px}

    /* Lists */
    .list{padding:15px}
    .card{background:var(--glass);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));border:1px solid rgba(255,255,255,0.2);border-radius:16px;padding:14px;margin-bottom:12px;box-shadow:0 8px 32px rgba(0,0,0,.08);cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);border-left:4px solid transparent;transform:translateZ(0)}
    .card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.12)}
    .card:active{transform:scale(0.98)}
    .card.i{border-left-color:#1a5c2e}.card.c{border-left-color:#2e7d32}.card.h{border-left-color:#66bb6a}
    .card.perfect{background:linear-gradient(135deg,#fff9e6,#fffdf7);border-left-color:#ffd700;box-shadow:0 2px 8px rgba(255,215,0,0.15);position:relative}.card.perfect:after{content:"PERFECT";position:absolute;top:8px;right:8px;background:linear-gradient(135deg,#ffd700,#ffb300);color:#fff;font-size:9px;font-weight:900;padding:2px 6px;border-radius:4px}
    .name{font-size:15px;font-weight:800;color:var(--fg);display:flex;align-items:center;gap:6px}
    .loc{font-size:12px;color:#777;margin-top:6px;display:flex;gap:6px;align-items:center}

    /* Nav */
    .nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #e0e0e0;display:flex;justify-content:space-around;padding:8px 0;z-index:3}
    @supports(padding:env(safe-area-inset-bottom)){.nav{padding-bottom:env(safe-area-inset-bottom)}}
    @media (min-width:768px){.nav{position:sticky;left:auto;right:auto}}
    .nav .it{flex:1;text-align:center;padding:6px 0;color:#667085;font-size:12px;cursor:pointer}
    .nav .it.active{color:var(--accent);font-weight:800}
    .icon{width:22px;height:22px;color:currentColor;display:inline-block;vertical-align:middle}
    .icon svg{width:100%;height:100%;display:block;fill:currentColor}
    .nav .icon{display:block;margin:0 auto 4px}

    /* FAB */
    .fab{position:fixed;right:20px;bottom:95px;width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(26,92,46,.4);cursor:pointer;z-index:4}

    /* Tabs */
    .tabs{display:flex;background:#fff;border-bottom:1px solid #e0e0e0}
    .tab{flex:1;padding:12px 0;text-align:center;font-size:13px;color:#666;cursor:pointer;font-weight:700;border-bottom:2px solid transparent}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}

    /* Info */
    .info{padding:15px;background:#fff;border-bottom:1px solid #eee}
    .row2{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f5f5f5}
    .val{font-weight:700;color:var(--fg)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:10px}
    .tile{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:12px;text-align:center;font-size:13px}
    .tile.y{background:#e8f5e9;border-color:var(--accent)}
    .tile.n{background:#ffebee;border-color:#d32f2f}

    /* Summary */
    .sum{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;padding:16px;margin:12px;border-radius:12px;box-shadow:0 4px 12px rgba(26,92,46,.25)}
    .sumg{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .sumi{background:rgba(255,255,255,.1);padding:10px;border-radius:8px;text-align:center}
    .sul{font-size:11px;opacity:.9;margin-bottom:3px}
    .suv{font-size:18px;font-weight:900}

    /* Actions */
    .acts{padding:12px;margin:0 12px 12px;background:#f7f7f7;border-radius:10px}
    .acti{background:#fff;border-left:3px solid var(--accent);padding:8px 10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;font-size:13px}

    /* Filters */
    .filters{padding:12px;background:#fff;border-bottom:1px solid #e0e0e0}
    .chips{display:flex;gap:8px;padding:8px 0;overflow:auto}
    .chip{padding:6px 14px;border:1px solid var(--border);border-radius:20px;background:#f9fbf9;font-size:12px;color:var(--fg);cursor:pointer;transition:.2s;white-space:nowrap}
    .chip:hover,.chip:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(26,92,46,.18);background:var(--chip);border-color:var(--accent);color:var(--accent)}
    .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  
    @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    @keyframes slideUp { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -20px); } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes countUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Animation classes for visits */
    .visit-card-animated { animation: fadeIn 0.5s ease-out backwards; }

    /* Toggle Switch Styles */
    .toggle-item{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#fff;border:1px solid #e0e0e0;border-radius:10px;margin-bottom:8px}
    .toggle-label{font-size:13px;color:var(--fg);font-weight:500}
    .toggle-switch{position:relative;width:48px;height:26px;background:#ccc;border-radius:13px;cursor:pointer;transition:all 0.4s cubic-bezier(0.68,-0.55,0.265,1.55)}
    .toggle-switch.on{background:linear-gradient(135deg,var(--accent),var(--electric));box-shadow:0 0 20px rgba(0,255,136,0.3)}
    .toggle-switch:before{content:'';position:absolute;width:22px;height:22px;border-radius:50%;background:#fff;top:2px;left:2px;transition:all 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);box-shadow:0 2px 4px rgba(0,0,0,.2)}
    .toggle-switch.on:before{transform:translateX(22px)}
    .toggle-switch:active:before{transform:scale(0.9)}

    /* Price Display */
    .price-group{margin-bottom:16px;padding:12px;background:#f9f9f9;border-radius:8px}
    .price-current{font-size:11px;color:#666;margin-bottom:4px}
    .price-current strong{color:var(--accent);font-size:13px}

    /* Skeleton Loader */
    .skeleton{animation:shimmer 2s infinite;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;border-radius:8px}
    .skeleton-card{height:80px;margin-bottom:12px}
    .skeleton-text{height:14px;margin-bottom:8px;width:60%}
    .skeleton-number{height:28px;width:40%;margin-bottom:4px}

    /* Progress Ring */
    .progress-ring{width:60px;height:60px;transform:rotate(-90deg)}
    .progress-ring-circle{transition:stroke-dashoffset 0.8s cubic-bezier(0.4,0,0.2,1);stroke:var(--electric);stroke-width:4;fill:none;stroke-linecap:round}
    .progress-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:14px;font-weight:900;color:var(--accent)}

    /* AI Insights */
    .ai-card{background:linear-gradient(135deg,rgba(0,255,136,0.05),rgba(26,92,46,0.05));border:1px solid rgba(0,255,136,0.2);border-radius:16px;padding:16px;margin:12px;position:relative;overflow:hidden}
    .ai-card:before{content:'';position:absolute;top:0;left:-100%;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--electric),transparent);animation:slideInRight 3s infinite}
    .ai-badge{display:inline-block;background:linear-gradient(135deg,var(--accent),var(--electric));color:#fff;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;margin-bottom:12px}
    .ai-insight{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.6);border-radius:10px;margin-bottom:8px;font-size:13px;animation:slideInRight 0.5s ease backwards}
    .ai-insight:nth-child(2){animation-delay:0.1s}
    .ai-insight:nth-child(3){animation-delay:0.2s}
    .ai-insight:nth-child(4){animation-delay:0.3s}
    .ai-metric{font-weight:900;color:var(--accent);font-size:16px}

    /* Count Animation */
    .count-up{animation:countUp 0.6s ease-out;display:inline-block}

    /* Haptic Feedback Simulation */
    .haptic{position:relative}
    .haptic:active:after{content:'';position:absolute;top:50%;left:50%;width:100%;height:100%;border:2px solid var(--electric);border-radius:inherit;transform:translate(-50%,-50%) scale(1.1);opacity:0;animation:hapticPulse 0.3s ease-out}
    @keyframes hapticPulse{0%{opacity:0.5;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.2)}}

  </style>
</head>
<body>
  <div class="phone">
    <!-- Login -->
    <div class="screen active" id="login">
      <div style="padding:24px 20px">
        <div style="text-align:center;margin-bottom:32px">
          <h1 style="color:var(--accent);margin-bottom:8px;font-size:24px;font-weight:900">JÄGERMEISTER Pulse</h1>
          <p style="font-size:13px;color:var(--muted)">Field Force Management System</p>
        </div>

        <div style="margin-bottom:24px">
          <h2 style="font-size:16px;font-weight:700;color:var(--fg);margin-bottom:16px;text-align:center">Choose Your Role</h2>

          <button class="role-btn" id="managerQuickLogin">
            <div class="role-btn-icon">
              <span class="icon" style="width:28px;height:28px" data-i="dashboard"></span>
            </div>
            <div class="role-btn-content">
              <div class="role-btn-title">Sign in as Manager</div>
              <div class="role-btn-desc">Access all regions, view analytics, manage team performance</div>
            </div>
          </button>

          <button class="role-btn" id="ambassadorQuickLogin">
            <div class="role-btn-icon">
              <span class="icon" style="width:28px;height:28px" data-i="user"></span>
            </div>
            <div class="role-btn-content">
              <div class="role-btn-title">Sign in as Ambassador</div>
              <div class="role-btn-desc">Manage venues, submit visit reports, track your performance</div>
            </div>
          </button>
        </div>

        <div class="collapsible" id="customLoginSection">
          <div class="collapsible-header">
            <span>Custom Login</span>
            <span class="collapsible-arrow">▼</span>
          </div>
          <div class="collapsible-content">
            <label class="label">Email</label>
            <input class="input" id="email" placeholder="Enter your email" style="margin-bottom:12px" />
            <label class="label">Password</label>
            <input class="input" id="pass" type="password" placeholder="Enter your password" style="margin-bottom:16px" />
            <button class="btn haptic" id="loginBtn"><span class="icon" data-i="user"></span><span>Sign In</span></button>
          </div>
        </div>

        <div style="margin-top:24px;padding:12px;background:#f9f9f9;border-radius:10px;font-size:11px;color:#999;text-align:center">
          Demo Mode • Offline • LocalStorage
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="screen" id="main">
      <div class="header">
        <h1 id="hdr">VENUES</h1>
        <div id="roleIndicator" style="font-size:11px;color:rgba(255,255,255,0.9);margin-top:4px"></div>
      </div>
      <div class="filters" id="filters"></div>
      <div class="content" id="content"></div>
      <button class="fab" id="fab" title="Add"></button>
      <div class="nav" id="nav">
        <!-- Navigation will be dynamically populated based on role -->
      </div>
    </div>

    <!-- Detail -->
    <div class="screen" id="detail">
      <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
          <button class="btn" id="backDetail" style="width:auto;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.2)"><span class="icon" data-i="arrowLeft"></span>Back</button>
          <h1 id="dName">Venue Name</h1>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" data-t="info">Information</div>
        <div class="tab" data-t="status">Status</div>
        <div class="tab" data-t="history">History</div>
      </div>
      <div class="content">
        <div id="tab-info">
          <div class="info">
            <div class="row2"><span class="label">Region</span><span class="val" id="dRegion">-</span></div>
            <div class="row2"><span class="label">Area</span><span class="val" id="dArea">-</span></div>
            <div class="row2"><span class="label">Type</span><span class="val" id="dType">-</span></div>
            <div class="row2"><span class="label">Category</span><span class="val" id="dCat">-</span></div>
          </div>
          <div class="info" style="margin-top:10px">
            <div class="row2"><span class="label">Shot Price</span><span class="val" id="dShot">-</span></div>
            <div class="row2"><span class="label">Bottle Price</span><span class="val" id="dBottle">-</span></div>
            <div class="row2"><span class="label">Avg Monthly Sales</span><span class="val" id="dSales">-</span></div>
          </div>
          <div id="visitButtonContainer" style="padding:15px"></div>
        </div>
        <div id="tab-status" style="display:none">
          <div class="info" style="border:none">
            <div class="grid" id="dStatus"></div>
          </div>
        </div>
        <div id="tab-history" style="display:none">
          <div class="list" id="dHist"></div>
        </div>
      </div>
    </div>

    <!-- Add Venue -->
    <div class="screen" id="add">
      <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
          <button class="btn" id="backAdd" style="width:auto;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.2)"><span class="icon" data-i="arrowLeft"></span>Back</button>
          <h1>NEW VENUE</h1>
        </div>
      </div>
      <div class="content">
        <div class="info" style="border:none">
          <div class="row" style="flex-direction:column;gap:8px">
            <label class="label">Venue Name</label>
            <input class="input" id="vName" placeholder="e.g. Potato Head Beach Club"/>
            <label class="label">Location</label>
            <select class="sel" id="vLoc"></select>
            <label class="label">Type</label>
            <select class="sel" id="vType"><option value="bar">Bar</option><option value="club">Club</option><option value="restaurant">Restaurant</option></select>
            <label class="label">Category</label>
            <select class="sel" id="vCat"><option value="must-win-image">Must Win Image</option><option value="must-win-commercial">Must Win Commercial</option><option value="high-importance">High Importance</option></select>
            <button class="btn" id="addBtn"><span class="icon" data-i="plus"></span>Add Venue</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Visit Report -->
    <div class="screen" id="visit">
      <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
          <button class="btn" id="backVisit" style="width:auto;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.2)"><span class="icon" data-i="arrowLeft"></span>Back</button>
          <h1>VISIT REPORT</h1>
        </div>
      </div>
      <div class="content">
        <div class="info" style="border:none">
          <div id="visitSel" class="row" style="flex-direction:column;gap:8px">
            <label class="label">Select Venue</label>
            <select class="sel" id="selVenue"><option value="">Select from list...</option></select>
          </div>
          <div class="info" style="margin-top:10px;border:none">
            <div class="row" style="flex-direction:column;gap:8px">
              <div class="price-group">
                <label class="label">Shot Price (IDR)</label>
                <div class="price-current" id="currentShot">Current: <strong>Loading...</strong></div>
                <input class="input" id="pShot" type="number" inputmode="numeric" placeholder="Enter new price"/>
              </div>
              <div class="price-group">
                <label class="label">Bottle Price (IDR)</label>
                <div class="price-current" id="currentBottle">Current: <strong>Loading...</strong></div>
                <input class="input" id="pBottle" type="number" inputmode="numeric" placeholder="Enter new price"/>
              </div>
              <div class="price-group">
                <label class="label">Avg Monthly Sales (bottles)</label>
                <div class="price-current" id="currentSales">Current: <strong>Loading...</strong></div>
                <input class="input" id="pSales" type="number" inputmode="numeric" placeholder="Enter new sales figure"/>
              </div>
            </div>
          </div>
          <div class="info" style="margin-top:10px;border:none">
            <div class="label" style="margin-bottom:12px;font-size:14px;font-weight:600">Update Venue Status</div>
            <div style="font-size:11px;color:#999;margin-bottom:10px">Toggle switches to update current status</div>
            <div id="toggles"></div>
          </div>
          <div class="info" style="margin-top:10px;border:none">
            <label class="label">Visit Notes</label>
            <textarea class="input" id="notes" rows="3" placeholder="Additional information..."></textarea>
            <div style="height:10px"></div>
            <button class="btn" id="saveVisit"><span class="icon" data-i="save"></span>Save Visit Report</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // Inline SVG icon set
    const ICONS={
      location:'<svg viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/></svg>',
      clipboard:'<svg viewBox="0 0 24 24"><path d="M9 2h6a2 2 0 0 1 2 2h2a1 1 0 0 1 1 1v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a1 1 0 0 1 1-1h2a2 2 0 0 1 2-2Zm0 3h6V4H9v1Z"/></svg>',
      chart:'<svg viewBox="0 0 24 24"><path d="M4 20h16v2H2V4h2v16Zm4 0v-7h3v7H8Zm5 0V6h3v14h-3Zm5 0v-11h3v11h-3Z"/></svg>',
      plus:'<svg viewBox="0 0 24 24"><path d="M11 11V4h2v7h7v2h-7v7h-2v-7H4v-2h7Z"/></svg>',
      arrowLeft:'<svg viewBox="0 0 24 24"><path d="M20 11v2H8l5 5-1.4 1.4L4.2 12l7.4-7.4L13 6l-5 5h12Z"/></svg>',
      edit:'<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm18.71-11.04a1.004 1.004 0 0 0 0-1.42l-2.5-2.5a1.004 1.004 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 2-1.66Z"/></svg>',
      calendar:'<svg viewBox="0 0 24 24"><path d="M7 2h2v2h6V2h2v2h3a2 2 0 0 1 2 2v3H2V6a2 2 0 0 1 2-2h3V2Zm15 8v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8h20Z"/></svg>',
      user:'<svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5v3h18v-3c0-2.5-4-5-9-5Z"/></svg>',
      check:'<svg viewBox="0 0 24 24"><path d="M9 16.2 4.8 12l-1.6 1.6L9 19.4l12-12-1.4-1.4Z"/></svg>',
      note:'<svg viewBox="0 0 24 24"><path d="M4 2h12l4 4v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm11 1v5h5"/></svg>',
      star:'<svg viewBox="0 0 24 24"><path d="M12 2 9.2 8H2l5.8 4.2L5.6 20 12 16.4 18.4 20l-2.2-7.8L22 8h-7.2L12 2Z"/></svg>',
      ok:'<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm-1 15-4-4 1.4-1.4L11 14.2l5.6-5.6L18 10Z"/></svg>',
      x:'<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm4.3 13.9-1.4 1.4L12 13.4l-2.9 2.9-1.4-1.4 2.9-2.9-2.9-2.9 1.4-1.4L12 10.6l2.9-2.9 1.4 1.4-2.9 2.9Z"/></svg>',
      pie:'<svg viewBox="0 0 24 24"><path d="M11 2a10 10 0 1 0 10 10h-8a2 2 0 0 1-2-2V2Z"/><path d="M13 2v8h8A10 10 0 0 0 13 2Z"/></svg>',
      save:'<svg viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4Zm-3 0v6H6V3h8Z"/></svg>',
      settings:'<svg viewBox="0 0 24 24"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/><path d="M19.4 15a8 8 0 0 0 .2-2 8 8 0 0 0-.2-2l2.1-1.6a.5.5 0 0 0 .1-.6l-2-3.5a.5.5 0 0 0-.6-.2l-2.5 1a7.4 7.4 0 0 0-1.7-1l-.4-2.7a.5.5 0 0 0-.5-.4h-4a.5.5 0 0 0-.5.4l-.4 2.6a7.6 7.6 0 0 0-1.7 1l-2.5-1a.5.5 0 0 0-.6.2l-2 3.5a.5.5 0 0 0 .1.6l2.1 1.6a8 8 0 0 0-.2 2 8 8 0 0 0 .2 2l-2.1 1.6a.5.5 0 0 0-.1.6l2 3.5a.5.5 0 0 0 .6.2l2.5-1a7.4 7.4 0 0 0 1.7 1l.4 2.7a.5.5 0 0 0 .5.4h4a.5.5 0 0 0 .5-.4l.4-2.6a7.6 7.6 0 0 0 1.7-1l2.5 1a.5.5 0 0 0 .6-.2l2-3.5a.5.5 0 0 0-.1-.6l-2.1-1.6Z"/></svg>',
      dashboard:'<svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10Zm0 8h8v-6H3v6Zm10 0h8V11h-8v10Zm0-18v6h8V3h-8Z"/></svg>',
      team:'<svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3Zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5s-3 1.34-3 3 1.34 3 3 3Zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5Zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5Z"/></svg>'
    };

    // Shortcuts
    const $=id=>document.getElementById(id);
    const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const esc=s=>String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const fmtIDR=new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0});
    const fmtInt=new Intl.NumberFormat('id-ID');

    // State
    let user=null; let venues=[], visits=[]; let tab='venues'; let current=null; let fromDetail=false; let selectedRegion='all';
    let userRole='ambassador'; // 'manager' or 'ambassador'
    let userRegion=''; // For ambassadors, their assigned region

    // Data helpers
    const locOptions=[
      {v:'',l:'All Locations'},
      {v:'bali|Seminyak',l:'Bali - Seminyak'},{v:'bali|Canggu',l:'Bali - Canggu'},{v:'bali|Uluwatu',l:'Bali - Uluwatu'},
      {v:'west-java|Jakarta',l:'West Java - Jakarta'},{v:'west-java|Bandung',l:'West Java - Bandung'},
      {v:'east-java|Surabaya',l:'East Java - Surabaya'},{v:'east-java|Malang',l:'East Java - Malang'}
    ];
    const perfect=v=>v.lightVisibility&&v.coolingDevice&&v.standardPOSM&&v.correctMenu&&v.promo&&v.iceColdServe&&v.staffTraining;
    const dateLocal=iso=>{const [y,m,d]=iso.split('-').map(Number);return new Date(y,m-1,d,12)};

    // Storage

    // Helper functions for validation
    function validateEmail(email) {
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      return emailRegex.test(email);
    }

    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/<script[^>]*>.*?<\/script>/gi, '')
                  .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
                  .replace(/on\w+="[^"]*"/gi, '')
                  .replace(/on\w+='[^']*'/gi, '');
    }

    function validatePrice(price) {
      const num = Number(price);
      if (isNaN(num) || num < 0 || num > 100000000) {
        return false;
      }
      return true;
    }

    // Toast notification system
    function showToast(msg, type='success'){
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = `<span class="icon">${type==='success'?ICONS.check:ICONS.x}</span> ${msg}`;
      toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:'+(type==='success'?'linear-gradient(135deg,#4caf50,#45a049)':'#f44336')+';color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.25);z-index:9999;animation:slideDown 0.3s ease';
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }

    function save(){
      try{
        // FIXED: Don't save userRole and userRegion to prevent role conflicts between users
        // These should be determined fresh on each login based on email
        localStorage.setItem('j101_state',JSON.stringify({venues,visits,selectedRegion,user}));
      }catch(e){
        console.error('Failed to save data:', e);
        showToast('Failed to save data', 'error');
      }
    }
    function load(){
      try{
        const s=JSON.parse(localStorage.getItem('j101_state'));
        if(s){
          venues=s.venues||[];
          visits=(s.visits||[]).map(v=>({...v,dateObj:v.dateObj?new Date(v.dateObj):v.date?dateLocal(v.date):new Date()}));
          selectedRegion=s.selectedRegion||'all';
          if(s.user){
            user={...user,...s.user};
          }
          // FIXED: Don't overwrite the current user's role and region
          // Only load role/region if they haven't been set yet (initial app load)
          // During login, these are already set based on the email
          // if(s.userRole) userRole = s.userRole;
          // if(s.userRegion) userRegion = s.userRegion;
          return true;
        }
      }catch(e){
        console.error('Failed to load data:', e);
      }
      return false;
    }

    // AI Insights Generator
    function generateInsights(venues,perfect,total){
      const insights=[];
      const needsAttention=venues.filter(v=>!v.contract&&v.category!=='high-importance').length;
      if(needsAttention>0) insights.push(`🎯 <span class="ai-metric">${needsAttention}</span> venues need immediate attention`);

      const almostPerfect=venues.filter(v=>{
        const compliance=[v.lightVisibility,v.coolingDevice,v.standardPOSM,v.correctMenu,v.promo,v.iceColdServe,v.staffTraining];
        const count=compliance.filter(c=>c).length;
        return count>=5&&count<7;
      }).length;
      if(almostPerfect>0) insights.push(`⚡ Quick win: <span class="ai-metric">${almostPerfect}</span> venues one step from Perfect`);

      const revenue=venues.filter(v=>!v.contract).reduce((sum,v)=>sum+(v.avgMonthlySales||0)*2500000,0);
      if(revenue>0) insights.push(`💰 Revenue opportunity: <span class="ai-metric">${fmtIDR.format(revenue)}</span> if contracts signed`);

      const perfectPerc=Math.round((perfect/total)*100);
      if(perfectPerc<40) insights.push(`📈 Performance boost needed: Only <span class="ai-metric">${perfectPerc}%</span> perfect outlets`);

      return insights.slice(0,3);
    }

    // Animate counters
    function animateCounters(){
      qsa('.count-up').forEach(el=>{
        const text=el.textContent;
        const num=parseInt(text.replace(/[^0-9]/g,''))||0;
        if(num>0){
          let current=0;
          const increment=num/30;
          const timer=setInterval(()=>{
            current+=increment;
            if(current>=num){
              current=num;
              clearInterval(timer);
              el.textContent=text;
            }else{
              el.textContent=text.includes('Rp')?fmtIDR.format(Math.floor(current)):Math.floor(current);
            }
          },30);
        }
      });
    }

    // Swipe Gesture Support
    function addSwipeGestures(element,onLeft,onRight){
      let startX=0,startY=0,endX=0,endY=0;
      element.addEventListener('touchstart',e=>{
        startX=e.changedTouches[0].screenX;
        startY=e.changedTouches[0].screenY;
      });
      element.addEventListener('touchend',e=>{
        endX=e.changedTouches[0].screenX;
        endY=e.changedTouches[0].screenY;
        const diffX=endX-startX;
        const diffY=endY-startY;
        if(Math.abs(diffX)>Math.abs(diffY)&&Math.abs(diffX)>50){
          if(diffX>0&&onRight) onRight();
          else if(diffX<0&&onLeft) onLeft();
        }
      });
    }

    // Show skeleton loaders
    function showSkeletons(container,count){
      let html='<div class="list">';
      for(let i=0;i<count;i++){
        html+=`<div class="skeleton skeleton-card" style="animation-delay:${i*0.1}s"></div>`;
      }
      html+='</div>';
      container.innerHTML=html;
    }

    // Advanced Filtering for Managers
    function renderAdvancedFilters(){
      if(userRole !== 'manager') return '';

      const regions = [
        {value: 'bali', label: 'Bali'},
        {value: 'west-java', label: 'West Java'},
        {value: 'east-java', label: 'East Java'}
      ];

      const locationsByRegion = {
        'bali': ['Seminyak', 'Canggu', 'Uluwatu'],
        'west-java': ['Jakarta', 'Bandung'],
        'east-java': ['Surabaya', 'Malang']
      };

      return `
      <div class="filter-section">
        <div class="filter-row">
          <div class="filter-col">
            <div class="filter-label">Region</div>
            <select class="sel" id="regionFilter" style="width:100%">
              <option value="all">All Regions</option>
              ${regions.map(r=>`<option value="${r.value}">${r.label}</option>`).join('')}
            </select>
          </div>
          <div class="filter-col">
            <div class="filter-label">Location</div>
            <select class="sel" id="locationFilter" style="width:100%">
              <option value="">All Locations</option>
            </select>
          </div>
        </div>
      </div>
      `;
    }


    // Seed data
    
    function seedEnhanced(){
      // Enhanced realistic demo data with real venue names
      venues=[
        // BALI - SEMINYAK (Premium nightlife area)
        { id:1,name:'Potato Head Beach Club',region:'bali',area:'Seminyak',category:'must-win-image',venueType:'club',shotPrice:145000,bottlePrice:2875000,avgMonthlySales:62,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:2,name:'La Favela',region:'bali',area:'Seminyak',category:'must-win-commercial',venueType:'bar',shotPrice:115000,bottlePrice:2295000,avgMonthlySales:48,contract:true,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:false,promo:false,iceColdServe:true,staffTraining:true },
        { id:3,name:'Ku De Ta',region:'bali',area:'Seminyak',category:'must-win-image',venueType:'club',shotPrice:155000,bottlePrice:3100000,avgMonthlySales:55,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:4,name:'Motel Mexicola',region:'bali',area:'Seminyak',category:'must-win-commercial',venueType:'bar',shotPrice:95000,bottlePrice:1950000,avgMonthlySales:72,contract:true,customBranding:true,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:true,promo:true,iceColdServe:true,staffTraining:false },
        { id:5,name:'Mirror Bali',region:'bali',area:'Seminyak',category:'must-win-image',venueType:'club',shotPrice:165000,bottlePrice:3295000,avgMonthlySales:38,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:6,name:'Red Ruby',region:'bali',area:'Seminyak',category:'high-importance',venueType:'bar',shotPrice:85000,bottlePrice:1750000,avgMonthlySales:31,contract:false,customBranding:false,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:true,staffTraining:false },

        // BALI - CANGGU (Surf & hipster scene)
        { id:7,name:'Finns Beach Club',region:'bali',area:'Canggu',category:'must-win-image',venueType:'club',shotPrice:125000,bottlePrice:2495000,avgMonthlySales:58,contract:false,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:8,name:'Old Man\'s',region:'bali',area:'Canggu',category:'must-win-commercial',venueType:'bar',shotPrice:75000,bottlePrice:1695000,avgMonthlySales:85,contract:true,customBranding:true,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:true,iceColdServe:false,staffTraining:false },
        { id:9,name:'The Lawn',region:'bali',area:'Canggu',category:'must-win-commercial',venueType:'bar',shotPrice:95000,bottlePrice:1995000,avgMonthlySales:43,contract:true,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:false,promo:true,iceColdServe:true,staffTraining:true },
        { id:10,name:'Atlas Beach Club',region:'bali',area:'Canggu',category:'must-win-image',venueType:'club',shotPrice:135000,bottlePrice:2695000,avgMonthlySales:47,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:11,name:'Pretty Poison',region:'bali',area:'Canggu',category:'high-importance',venueType:'bar',shotPrice:78000,bottlePrice:1595000,avgMonthlySales:29,contract:false,customBranding:false,lightVisibility:false,coolingDevice:false,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:false,staffTraining:false },
        { id:12,name:'Luigi\'s Hot Pizza',region:'bali',area:'Canggu',category:'high-importance',venueType:'restaurant',shotPrice:68000,bottlePrice:1450000,avgMonthlySales:22,contract:false,customBranding:false,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:true,staffTraining:false },

        // BALI - ULUWATU (Cliff-top luxury)
        { id:13,name:'Rock Bar',region:'bali',area:'Uluwatu',category:'must-win-image',venueType:'bar',shotPrice:175000,bottlePrice:3495000,avgMonthlySales:42,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:14,name:'Single Fin',region:'bali',area:'Uluwatu',category:'must-win-commercial',venueType:'bar',shotPrice:85000,bottlePrice:1895000,avgMonthlySales:67,contract:true,customBranding:false,lightVisibility:true,coolingDevice:false,standardPOSM:true,correctMenu:true,promo:false,iceColdServe:true,staffTraining:false },
        { id:15,name:'Omnia Dayclub',region:'bali',area:'Uluwatu',category:'must-win-image',venueType:'club',shotPrice:185000,bottlePrice:3695000,avgMonthlySales:36,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:16,name:'El Kabron',region:'bali',area:'Uluwatu',category:'must-win-commercial',venueType:'club',shotPrice:145000,bottlePrice:2895000,avgMonthlySales:31,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:false,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:17,name:'Ulu Cliffhouse',region:'bali',area:'Uluwatu',category:'must-win-image',venueType:'club',shotPrice:165000,bottlePrice:3295000,avgMonthlySales:28,contract:false,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:true,staffTraining:false },

        // JAKARTA - Capital nightlife
        { id:18,name:'Dragonfly',region:'west-java',area:'Jakarta',category:'must-win-image',venueType:'club',shotPrice:155000,bottlePrice:3095000,avgMonthlySales:78,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:19,name:'Colosseum',region:'west-java',area:'Jakarta',category:'must-win-image',venueType:'club',shotPrice:165000,bottlePrice:3295000,avgMonthlySales:65,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:20,name:'Fable',region:'west-java',area:'Jakarta',category:'must-win-commercial',venueType:'bar',shotPrice:125000,bottlePrice:2495000,avgMonthlySales:52,contract:true,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:false,correctMenu:true,promo:true,iceColdServe:true,staffTraining:false },
        { id:21,name:'Immigrant',region:'west-java',area:'Jakarta',category:'must-win-image',venueType:'club',shotPrice:175000,bottlePrice:3495000,avgMonthlySales:71,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:22,name:'Jenja',region:'west-java',area:'Jakarta',category:'must-win-image',venueType:'club',shotPrice:185000,bottlePrice:3695000,avgMonthlySales:68,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:23,name:'Leon Goldstein',region:'west-java',area:'Jakarta',category:'high-importance',venueType:'bar',shotPrice:95000,bottlePrice:1995000,avgMonthlySales:38,contract:false,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:true,staffTraining:false },
        { id:24,name:'Lucy in the Sky',region:'west-java',area:'Jakarta',category:'must-win-commercial',venueType:'bar',shotPrice:135000,bottlePrice:2695000,avgMonthlySales:45,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:false,iceColdServe:true,staffTraining:true },
        { id:25,name:'Holywings',region:'west-java',area:'Jakarta',category:'high-importance',venueType:'bar',shotPrice:75000,bottlePrice:1595000,avgMonthlySales:92,contract:false,customBranding:false,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:true,staffTraining:false },

        // BANDUNG - University city nightlife
        { id:26,name:'Noah\'s Barn',region:'west-java',area:'Bandung',category:'must-win-commercial',venueType:'bar',shotPrice:65000,bottlePrice:1495000,avgMonthlySales:34,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:27,name:'Shelter',region:'west-java',area:'Bandung',category:'high-importance',venueType:'club',shotPrice:75000,bottlePrice:1695000,avgMonthlySales:28,contract:true,customBranding:false,lightVisibility:true,coolingDevice:false,standardPOSM:true,correctMenu:false,promo:true,iceColdServe:false,staffTraining:true },
        { id:28,name:'Embassy',region:'west-java',area:'Bandung',category:'must-win-commercial',venueType:'club',shotPrice:85000,bottlePrice:1895000,avgMonthlySales:41,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:false,correctMenu:true,promo:true,iceColdServe:true,staffTraining:false },
        { id:29,name:'Badung Cafe',region:'west-java',area:'Bandung',category:'high-importance',venueType:'bar',shotPrice:55000,bottlePrice:1295000,avgMonthlySales:19,contract:false,customBranding:false,lightVisibility:false,coolingDevice:false,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:false,staffTraining:false },

        // SURABAYA - East Java commercial hub
        { id:30,name:'Colors Pub',region:'east-java',area:'Surabaya',category:'must-win-commercial',venueType:'bar',shotPrice:95000,bottlePrice:1995000,avgMonthlySales:45,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
        { id:31,name:'Our Bar',region:'east-java',area:'Surabaya',category:'high-importance',venueType:'bar',shotPrice:75000,bottlePrice:1695000,avgMonthlySales:38,contract:false,customBranding:false,lightVisibility:false,coolingDevice:false,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:false,staffTraining:false },
        { id:32,name:'Calibre',region:'east-java',area:'Surabaya',category:'must-win-commercial',venueType:'club',shotPrice:105000,bottlePrice:2195000,avgMonthlySales:52,contract:true,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:false,promo:true,iceColdServe:true,staffTraining:true },
        { id:33,name:'Tavern Pub',region:'east-java',area:'Surabaya',category:'high-importance',venueType:'bar',shotPrice:65000,bottlePrice:1495000,avgMonthlySales:31,contract:true,customBranding:false,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:true,promo:false,iceColdServe:true,staffTraining:false },
        { id:34,name:'Desperados',region:'east-java',area:'Surabaya',category:'must-win-commercial',venueType:'bar',shotPrice:85000,bottlePrice:1895000,avgMonthlySales:47,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:false,iceColdServe:true,staffTraining:true },

        // MALANG - University town
        { id:35,name:'Nakoa Bar',region:'east-java',area:'Malang',category:'high-importance',venueType:'bar',shotPrice:55000,bottlePrice:1295000,avgMonthlySales:22,contract:false,customBranding:false,lightVisibility:false,coolingDevice:false,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:false,staffTraining:false },
        { id:36,name:'The Loft',region:'east-java',area:'Malang',category:'high-importance',venueType:'bar',shotPrice:65000,bottlePrice:1495000,avgMonthlySales:18,contract:false,customBranding:false,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:true,staffTraining:false },
        { id:37,name:'Bukit Delight',region:'east-java',area:'Malang',category:'high-importance',venueType:'restaurant',shotPrice:45000,bottlePrice:1095000,avgMonthlySales:12,contract:false,customBranding:false,lightVisibility:false,coolingDevice:false,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:false,staffTraining:false }
      ];

      // Generate realistic visit history with actual changes for specific ambassadors
      const visitData = [];

      // Define ambassadors with their assigned regions - matching login email patterns
      const ambassadors = [
        { name: 'John Bali', email: 'john.bali@', region: 'bali', areas: ['Seminyak', 'Canggu', 'Uluwatu'] },
        { name: 'Sarah Jakarta', email: 'sarah.jakarta@', region: 'west-java', areas: ['Jakarta'] },
        { name: 'Mike Surabaya', email: 'mike.surabaya@', region: 'east-java', areas: ['Surabaya'] },
        { name: 'Emma Bali', email: 'emma.bali@', region: 'bali', areas: ['Seminyak', 'Canggu'] },
        { name: 'David Bandung', email: 'david.bandung@', region: 'west-java', areas: ['Bandung'] },
        { name: 'Lisa Bali', email: 'lisa.bali@', region: 'bali', areas: ['Uluwatu'] },
        { name: 'Tom Malang', email: 'tom.malang@', region: 'east-java', areas: ['Malang'] },
        { name: 'Jessica Jakarta', email: 'jessica.jakarta@', region: 'west-java', areas: ['Jakarta'] }
      ];
      const changeActions = [
        ['✓ Contract Signed activated', 'Shot price updated to Rp 125,000'],
        ['✓ Custom Branding activated', '✓ Light Visibility activated'],
        ['✗ Promo Active deactivated', 'Bottle price updated to Rp 2,495,000'],
        ['✓ Staff Training activated', '✓ Ice-cold Serve activated'],
        ['✓ Standard POSM activated', 'Monthly sales updated to 45 bottles'],
        ['✗ Correct Menu deactivated', 'Shot price updated to Rp 95,000'],
        ['✓ Cooling Device activated', '✓ Promo Active activated'],
        ['Routine check - no changes'],
        ['✓ Contract Signed activated', '✓ Custom Branding activated', 'Bottle price updated to Rp 2,895,000'],
        ['✗ Staff Training deactivated', 'Monthly sales updated to 32 bottles'],
        ['✓ Light Visibility activated', '✓ Standard POSM activated', '✓ Correct Menu activated'],
        ['Shot price updated to Rp 145,000', 'Bottle price updated to Rp 3,295,000'],
        ['✓ Ice-cold Serve activated', '✓ Staff Training activated'],
        ['✗ Custom Branding deactivated', '✗ Promo Active deactivated'],
        ['✓ Cooling Device activated', 'Monthly sales updated to 58 bottles']
      ];

      const visitNotes = [
        'Venue fully compliant, ready for year-end campaign',
        'Manager requested better pricing for bulk orders',
        'New staff needs training on ice-cold serve standards',
        'Competitor offering better rates, need to discuss with management',
        'Perfect outlet achieved! Celebrate with team',
        'Cooling device needs maintenance, scheduled for next week',
        'Contract renewal discussion scheduled for next month',
        '',
        'Great improvement since last visit',
        'POSM materials running low, reorder needed',
        'Staff very engaged with new training program',
        '',
        'Venue preparing for major event next month',
        'Custom branding installation completed successfully',
        ''
      ];

      let visitId = 1;
      const today = new Date();

      // Generate visits for each ambassador
      ambassadors.forEach(ambassador => {
        // Get venues for this ambassador's region
        const regionVenues = venues.filter(v => v.region === ambassador.region);

        // Generate 10-20 visits per ambassador over the past 30 days
        const numVisits = Math.floor(Math.random() * 11) + 10;

        for (let i = 0; i < numVisits; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() - Math.floor(Math.random() * 30));
          const dateStr = date.toISOString().split('T')[0];

          // Select a random venue from ambassador's region
          const venue = regionVenues[Math.floor(Math.random() * regionVenues.length)];
          if (!venue) continue;

          const actionSet = changeActions[Math.floor(Math.random() * changeActions.length)];
          const noteIdx = Math.floor(Math.random() * visitNotes.length);

          visitData.push({
            id: visitId++,
            venueId: venue.id,
            date: dateStr,
            dateObj: dateLocal(dateStr),
            user: ambassador.name,
            ambassadorName: ambassador.name,
            actions: Array.isArray(actionSet) ? actionSet : [actionSet],
            notes: visitNotes[noteIdx]
          });
        }
      });

      visits = visitData.sort((a, b) => b.dateObj - a.dateObj);
      save(); // Save the enhanced data to localStorage
    }

    function seed(){ venues=[
      { id:1,name:'Potato Head Beach Club',region:'bali',area:'Seminyak',category:'must-win-image',venueType:'club',shotPrice:125000,bottlePrice:2500000,avgMonthlySales:45,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:2,name:'La Favela',region:'bali',area:'Seminyak',category:'must-win-commercial',venueType:'bar',shotPrice:95000,bottlePrice:2200000,avgMonthlySales:38,contract:true,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:false,promo:false,iceColdServe:true,staffTraining:true },
      { id:3,name:'Finns Beach Club',region:'bali',area:'Canggu',category:'must-win-image',venueType:'club',shotPrice:120000,bottlePrice:2450000,avgMonthlySales:42,contract:false,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:4,name:'Old Mans',region:'bali',area:'Canggu',category:'must-win-commercial',venueType:'bar',shotPrice:85000,bottlePrice:1950000,avgMonthlySales:55,contract:true,customBranding:true,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:true,iceColdServe:false,staffTraining:false },
      { id:5,name:'Rock Bar',region:'bali',area:'Uluwatu',category:'must-win-image',venueType:'bar',shotPrice:135000,bottlePrice:2800000,avgMonthlySales:35,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:6,name:'Dragonfly',region:'west-java',area:'Jakarta',category:'must-win-image',venueType:'club',shotPrice:125000,bottlePrice:2600000,avgMonthlySales:65,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:7,name:'Noah Barn',region:'west-java',area:'Bandung',category:'must-win-commercial',venueType:'bar',shotPrice:75000,bottlePrice:1800000,avgMonthlySales:22,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:8,name:'Colors Pub',region:'east-java',area:'Surabaya',category:'must-win-commercial',venueType:'bar',shotPrice:85000,bottlePrice:2000000,avgMonthlySales:35,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true }
    ];
    visits=[
      { id:1,venueId:1,date:'2024-12-20',dateObj:dateLocal('2024-12-20'),user:'John Bali',ambassadorName:'John Bali',actions:['Staff training done','Standard POSM placed','Perfect Outlet status achieved'],notes:'Year-end campaign ready.' },
      { id:2,venueId:6,date:'2024-12-20',dateObj:dateLocal('2024-12-20'),user:'Sarah Jakarta',ambassadorName:'Sarah Jakarta',actions:['Contract signed','Custom branding installed','Perfect Outlet status achieved'],notes:'Premium Jakarta placement.' },
      { id:3,venueId:4,date:'2024-12-19',dateObj:dateLocal('2024-12-19'),user:'John Bali',ambassadorName:'John Bali',actions:['Light visibility placed','Staff training done'],notes:'Improve POSM next time.' },
      { id:4,venueId:3,date:'2024-12-18',dateObj:dateLocal('2024-12-18'),user:'John Bali',ambassadorName:'John Bali',actions:['Contract negotiation','Perfect Outlet status achieved'],notes:'Contract pending approval.' },
      { id:5,venueId:8,date:'2024-12-19',dateObj:dateLocal('2024-12-19'),user:'Mike Surabaya',ambassadorName:'Mike Surabaya',actions:['Staff training done','Ice-cold serve checked'],notes:'Good progress.' },
      { id:6,venueId:2,date:'2024-12-18',dateObj:dateLocal('2024-12-18'),user:'Emma Bali',ambassadorName:'Emma Bali',actions:['Cooling device checked','Promo materials updated'],notes:'Follow up next week.' },
      { id:7,venueId:7,date:'2024-12-17',dateObj:dateLocal('2024-12-17'),user:'David Bandung',ambassadorName:'David Bandung',actions:['Contract negotiation started'],notes:'Decision pending.' }
    ]; }

    // Screens & Tabs
    function show(id){ qsa('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); toggleFab(); if(id==='visit' && !fromDetail){ fillVisitSelect(); buildToggles(); } }
    function toggleFab(){ const on=$('main').classList.contains('active') && tab!=='statistics' && tab!=='settings' && userRole==='ambassador'; $('fab').style.display=on?'flex':'none'; }
    function setTab(t){
      tab=t;
      qsa('.nav .it').forEach(i=>i.classList.toggle('active',i.dataset.tab===t));
      const h=$('hdr');
      if(t==='venues'){
        h.textContent='VENUES';
        renderVenueFilters();
        renderVenues();
      } else if(t==='visits'){
        h.textContent='VISITS';
        renderVisitFilters();
        renderVisits();
      } else if(t==='statistics'){
        h.textContent='STATISTICS';
        renderStatFilters();
        renderStats();
      } else if(t==='settings'){
        h.textContent='SETTINGS';
        renderSettings();
      }
      toggleFab();
    }

    // Removed Dashboard - managers now start on Venues

    // Team leaderboard for managers (now in Statistics)
    function renderTeamLeaderboard(filteredVisits){
      // This function is called from Statistics tab for managers only
      const visitsToUse = filteredVisits || visits;
      const ambassadors = {};
      const today = new Date();
      const last7Days = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      const last30Days = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

      // Map ambassador names to their regions - matching login names
      const ambassadorRegions = {
        'John Bali': 'Bali',
        'Sarah Jakarta': 'West Java',
        'Mike Surabaya': 'East Java',
        'Emma Bali': 'Bali',
        'David Bandung': 'West Java',
        'Lisa Bali': 'Bali',
        'Tom Malang': 'East Java',
        'Jessica Jakarta': 'West Java'
      };

      visitsToUse.forEach(v => {
        const name = v.ambassadorName || v.user || 'Unknown';
        const region = ambassadorRegions[name] || v.ambassadorRegion || 'Unknown';
        if(!ambassadors[name]) {
          ambassadors[name] = {
            name,
            region,
            visits: 0,
            visitsLast7Days: 0,
            visitsLast30Days: 0,
            perfectVenues: new Set(),
            lastVisit: null,
            venues: new Set()
          };
        }
        ambassadors[name].visits++;
        ambassadors[name].venues.add(v.venueId);

        // Track recent activity
        const visitDate = v.dateObj || new Date(v.date);
        if(visitDate >= last7Days) ambassadors[name].visitsLast7Days++;
        if(visitDate >= last30Days) ambassadors[name].visitsLast30Days++;

        // Track last visit
        if(!ambassadors[name].lastVisit || visitDate > ambassadors[name].lastVisit) {
          ambassadors[name].lastVisit = visitDate;
        }

        const venue = venues.find(ven => ven.id === v.venueId);
        if(venue && perfect(venue)) {
          ambassadors[name].perfectVenues.add(v.venueId);
        }
      });

      const ambassadorList = Object.values(ambassadors).sort((a,b) => b.visitsLast7Days - a.visitsLast7Days);

      // Calculate performance scores
      ambassadorList.forEach(amb => {
        amb.perfScore = Math.round(
          (amb.perfectVenues.size * 100 / Math.max(amb.venues.size, 1))
        );
        amb.activityTrend = amb.visitsLast7Days > 0 ? 'active' :
                            amb.visitsLast30Days > 0 ? 'moderate' : 'inactive';
      });

      return `
        <div class="info" style="border-top:2px solid #e0e0e0;margin-top:20px;padding-top:20px">
          <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;color:var(--fg)">Team Performance Dashboard</h3>

          <!-- Quick stats -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px">
            <div style="background:#f8f9fa;padding:12px;border-radius:8px">
              <div style="font-size:11px;color:#666">Active Ambassadors</div>
              <div style="font-size:20px;font-weight:700;color:var(--accent)">${ambassadorList.filter(a => a.visitsLast7Days > 0).length}</div>
            </div>
            <div style="background:#f8f9fa;padding:12px;border-radius:8px">
              <div style="font-size:11px;color:#666">Weekly Visits</div>
              <div style="font-size:20px;font-weight:700;color:var(--electric)">${ambassadorList.reduce((sum, a) => sum + a.visitsLast7Days, 0)}</div>
            </div>
            <div style="background:#f8f9fa;padding:12px;border-radius:8px">
              <div style="font-size:11px;color:#666">Avg Performance</div>
              <div style="font-size:20px;font-weight:700;color:#4caf50">${Math.round(ambassadorList.reduce((sum, a) => sum + a.perfScore, 0) / Math.max(ambassadorList.length, 1))}%</div>
            </div>
          </div>

          <div style="overflow-x:auto">
            <table style="width:100%;font-size:13px">
              <thead>
                <tr style="border-bottom:2px solid #e0e0e0">
                  <th style="text-align:left;padding:8px;color:#666;font-weight:600">Ambassador</th>
                  <th style="text-align:left;padding:8px;color:#666;font-weight:600">Region</th>
                  <th style="text-align:center;padding:8px;color:#666;font-weight:600">7-Day Activity</th>
                  <th style="text-align:center;padding:8px;color:#666;font-weight:600">Perfect %</th>
                  <th style="text-align:right;padding:8px;color:#666;font-weight:600">Total Visits</th>
                  <th style="text-align:center;padding:8px;color:#666;font-weight:600">Status</th>
                </tr>
              </thead>
              <tbody>
                ${ambassadorList.map((amb, index) => {
                  const statusColor = amb.activityTrend === 'active' ? '#4caf50' :
                                     amb.activityTrend === 'moderate' ? '#ff9800' : '#f44336';
                  const statusIcon = amb.activityTrend === 'active' ? '●' :
                                    amb.activityTrend === 'moderate' ? '◐' : '○';
                  const medalColor = index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '';

                  return `
                  <tr style="border-bottom:1px solid #f0f0f0;${amb.activityTrend === 'inactive' ? 'opacity:0.7' : ''}">
                    <td style="padding:12px">
                      <div style="display:flex;align-items:center;gap:8px">
                        ${medalColor ? `<span style="font-weight:900;color:${medalColor};font-size:16px">${index + 1}</span>` : ''}
                        <div>
                          <div style="font-weight:600">${amb.name}</div>
                          ${amb.lastVisit ? `<div style="font-size:11px;color:#999">Last: ${amb.lastVisit.toLocaleDateString()}</div>` : ''}
                        </div>
                      </div>
                    </td>
                    <td style="padding:12px;color:#666">${amb.region.charAt(0).toUpperCase() + amb.region.slice(1).replace('-',' ')}</td>
                    <td style="padding:12px;text-align:center">
                      <div style="display:flex;align-items:center;justify-content:center;gap:4px">
                        <div style="font-weight:700;color:var(--accent)">${amb.visitsLast7Days}</div>
                        <div style="font-size:11px;color:#999">/ ${amb.visitsLast30Days}</div>
                      </div>
                    </td>
                    <td style="padding:12px;text-align:center">
                      <div style="display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:12px;background:${amb.perfScore >= 80 ? '#e8f5e9' : amb.perfScore >= 50 ? '#fff3e0' : '#ffebee'}">
                        <span style="font-weight:700;color:${amb.perfScore >= 80 ? '#4caf50' : amb.perfScore >= 50 ? '#ff9800' : '#f44336'}">${amb.perfScore}%</span>
                      </div>
                    </td>
                    <td style="padding:12px;text-align:right;font-weight:600">${amb.visits}</td>
                    <td style="padding:12px;text-align:center">
                      <span style="color:${statusColor};font-size:16px" title="${amb.activityTrend}">${statusIcon}</span>
                    </td>
                  </tr>
                `}).join('')}
              </tbody>
            </table>
          </div>

          <!-- Legend -->
          <div style="display:flex;gap:20px;margin-top:16px;padding:12px;background:#f8f9fa;border-radius:8px;font-size:11px;color:#666">
            <div><span style="color:#4caf50">●</span> Active (visited in last 7 days)</div>
            <div><span style="color:#ff9800">◐</span> Moderate (visited in last 30 days)</div>
            <div><span style="color:#f44336">○</span> Inactive (no recent visits)</div>
          </div>
        </div>
      `;
    }

    // Venues list
    function renderVenueFilters(){
      const f=$('filters');

      // Enhanced filters for managers
      if(userRole === 'manager') {
        f.innerHTML = renderAdvancedFilters();
        // Setup filter event listeners after rendering
        setTimeout(()=>{
          // Location data
          const locationsByRegion = {
            'bali': ['Seminyak', 'Canggu', 'Uluwatu'],
            'west-java': ['Jakarta', 'Bandung'],
            'east-java': ['Surabaya', 'Malang']
          };

          // Region dropdown
          const regionFilter = $('regionFilter');
          const locationFilter = $('locationFilter');

          if(regionFilter) {
            regionFilter.addEventListener('change',()=>{
              const region = regionFilter.value;
              selectedRegion = region;

              // Update location dropdown
              if(region === 'all') {
                locationFilter.innerHTML = '<option value="">All Locations</option>';
              } else {
                const locations = locationsByRegion[region] || [];
                locationFilter.innerHTML = '<option value="">All Locations</option>' +
                  locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
              }
              locationFilter.value = '';

              // Filter venues
              applyVenueFilters();
            });
          }

          // Location filter
          if(locationFilter) {
            locationFilter.addEventListener('change',()=>{
              applyVenueFilters();
            });
          }

          // Helper function to apply filters
          function applyVenueFilters() {
            const region = $('regionFilter')?.value || 'all';
            const location = $('locationFilter')?.value || '';

            let filtered = venues;

            if(region !== 'all') {
              filtered = filtered.filter(v => v.region === region);
            }

            if(location) {
              filtered = filtered.filter(v => v.area === location);
            }

            renderVenues(filtered);
          }

        },100);
      } else {
        // Simple filters for ambassadors
        const opts = locOptions
          .filter(o => o.v === '' || o.v.startsWith(userRegion))
          .map(o => `<option value="${o.v}">${o.l}</option>`)
          .join('');
        f.innerHTML=`
          <div class="row"><select class="sel" id="fLoc">${opts}</select></div>
          <div class="row"><select class="sel" id="fCat"><option value="">All Categories</option><option value="must-win-image">Must Win Image</option><option value="must-win-commercial">Must Win Commercial</option><option value="high-importance">High Importance</option></select>
          <select class="sel" id="fType"><option value="">All Types</option><option value="bar">Bar</option><option value="club">Club</option><option value="restaurant">Restaurant</option></select></div>
          <div class="row"><input class="input" id="fQuery" placeholder="Search by venue name..."/></div>`;
        $('fLoc').addEventListener('change',filterVenues);
        ['fCat','fType'].forEach(id=>$(id)?.addEventListener('change',filterVenues));
        $('fQuery').addEventListener('input',filterVenues);
      }
    }
    function filterVenues(){
      const loc=$('fLoc')?.value,cat=$('fCat').value,typ=$('fType').value,q=($('fQuery').value||'').toLowerCase();
      let arr=venues.filter(v=>v.name.toLowerCase().includes(q));

      // Filter based on user role
      if(userRole === 'ambassador') {
        arr = arr.filter(v => v.region === userRegion);
      }

      // Venues tab has full freedom - no selectedRegion restrictions
      if(loc){
        const [r,a]=loc.split('|');
        arr=arr.filter(v=>a==='all'?v.region===r:(v.region===r&&v.area===a));
      }

      if(cat) arr=arr.filter(v=>v.category===cat);
      if(typ) arr=arr.filter(v=>v.venueType===typ);
      renderVenues(arr);
    }
    function renderVenues(arr){
      const c=$('content');
      // Filter venues based on user role
      let baseVenues = venues;
      if(userRole === 'ambassador') {
        // Ambassadors only see venues in their region
        baseVenues = venues.filter(v => v.region === userRegion);
      }
      // Use filtered array if provided, otherwise use role-filtered venues
      let data = arr || baseVenues;

      // Sort venues alphabetically by name (A-Z) for both roles
      data = [...data].sort((a,b) => {
        return a.name.localeCompare(b.name);
      });

      // Show skeleton loader briefly
      showSkeletons(c,3);
      setTimeout(()=>{
        if(!data.length){
          c.innerHTML='<p style="text-align:center;color:#999;padding:40px">No venues</p>';
          return;
        }

        // Summary statistics removed for ambassadors - they focus on individual venue management
        let html='<div class="list">';
        data.forEach(v=>{
          // Re-check perfect status for each venue to ensure accuracy
          const isPerfect = perfect(v);

          // Calculate completion percentage for priority indicator
          const toggleCount = [v.lightVisibility, v.coolingDevice, v.standardPOSM,
                              v.correctMenu, v.promo, v.iceColdServe, v.staffTraining]
                              .filter(Boolean).length;
          const completion = Math.round(toggleCount * 100 / 7);

          // Debug La Favela specifically
          if (v.name === 'La Favela') {
            console.log('Rendering La Favela:', {
              lightVisibility: v.lightVisibility,
              coolingDevice: v.coolingDevice,
              standardPOSM: v.standardPOSM,
              correctMenu: v.correctMenu,
              promo: v.promo,
              iceColdServe: v.iceColdServe,
              staffTraining: v.staffTraining,
              isPerfect: isPerfect
            });

            // Double-check: a venue should ONLY be perfect if ALL 7 toggles are true
            if (isPerfect && (!v.lightVisibility || !v.coolingDevice || !v.standardPOSM ||
                             !v.correctMenu || !v.promo || !v.iceColdServe || !v.staffTraining)) {
              console.error('ERROR: La Favela showing as perfect but has false toggles!');
            }
          }

          const k=v.category==='must-win-image'?'i':v.category==='must-win-commercial'?'c':'h';

          // Only show PERFECT badge, no priority indicators for ambassadors
          let priorityIndicator = '';

          html+=`<div class="card ${k}${isPerfect?' perfect':''}" data-id="${v.id}" style="position:relative">`+
            priorityIndicator +
            `<div class="name">${esc(v.name)}</div>`+
            `<div class="loc"><span class="icon">${ICONS.location}</span>${esc(v.area)}, ${esc(v.region.charAt(0).toUpperCase() + v.region.slice(1).replace('-', ' '))}</div>`+
            `</div>`;
        });
        html+='</div>';
        c.innerHTML=html;
        qsa('.card',c).forEach(el=>el.addEventListener('click',()=>openDetail(Number(el.dataset.id))));
      },150);
    }

    // Visits
    function renderVisitFilters(){
      const f=$('filters');
      const t=new Date(),m=new Date();
      m.setMonth(t.getMonth()-1);
      const to=d=>d.toISOString().split('T')[0];

      // Build region filter for managers, area filter for ambassadors
      let regionHtml = '';
      let areaHtml = '';

      if(userRole === 'manager') {
        // Managers get region selector
        const regions = [...new Set(venues.map(v => v.region))].sort();
        const regionOptions = '<option value="">All Regions</option>' + regions.map(r =>
          `<option value="${r}">${r.charAt(0).toUpperCase() + r.slice(1).replace('-', ' ')}</option>`
        ).join('');
        regionHtml = `<div class="row"><select class="sel" id="vRegion">${regionOptions}</select></div>`;
      } else if(selectedRegion !== 'all') {
        // Ambassadors see area filter for their region
        const areas = [...new Set(venues.filter(v => v.region === selectedRegion).map(v => v.area))].sort();
        const areaOptions = '<option value="">All Areas</option>' + areas.map(a => `<option value="${a}">${a}</option>`).join('');
        areaHtml = `<div class="row"><select class="sel" id="vArea">${areaOptions}</select></div>`;
      }

      f.innerHTML=`
      ${regionHtml}
      ${areaHtml}
      <div class="row"><input type="date" class="date" id="dFrom" value="${to(m)}"><input type="date" class="date" id="dTo" value="${to(t)}"></div>
      <div class="chips"><button class="chip" data-p="week">Week</button><button class="chip active" data-p="month">Month</button><button class="chip" data-p="quarter">Quarter</button><button class="chip" data-p="year">Year</button><button class="chip" data-p="all">All</button></div>`;

      $('dFrom').addEventListener('change',renderVisits);
      $('dTo').addEventListener('change',renderVisits);
      if($('vRegion')) $('vRegion').addEventListener('change',renderVisits);
      if($('vArea')) $('vArea').addEventListener('change',renderVisits);
      qsa('.chip',f).forEach(b=>b.addEventListener('click',()=>setPeriod(b.dataset.p,b)));
    }
    function setPeriod(p,btn){ qsa('.chip').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); const t=new Date(); let f=new Date(); if(p==='week') f.setDate(t.getDate()-7); else if(p==='month') f.setMonth(t.getMonth()-1); else if(p==='quarter') f.setMonth(t.getMonth()-3); else if(p==='year') f.setFullYear(t.getFullYear()-1); else f=new Date('2024-01-01'); $('dFrom').value=f.toISOString().split('T')[0]; $('dTo').value=t.toISOString().split('T')[0]; renderVisits(); }
    function renderVisits(){
      const from=new Date($('dFrom').value), to=new Date($('dTo').value);
      to.setHours(23,59,59,999);
      let list=visits.filter(v=>v.dateObj>=from&&v.dateObj<=to);

      // Filter visits based on role
      if(userRole === 'ambassador') {
        // Ambassadors only see their own visits
        list = list.filter(v => v.ambassadorName === user?.name || v.user === user?.name);
      }

      // Apply filters based on role
      if(userRole === 'manager') {
        // Managers can filter by region if they choose
        const regionFilter = $('vRegion')?.value;
        if(regionFilter) {
          const regionVenues = venues.filter(v => v.region === regionFilter);
          list = list.filter(v => regionVenues.some(rv => rv.id === v.venueId));
        }
      } else if(userRole === 'ambassador' && selectedRegion !== 'all') {
        // Ambassadors filter by area within their region
        const regionVenues = venues.filter(v => v.region === selectedRegion);
        const areaFilter = $('vArea')?.value;
        if(areaFilter) {
          const areaVenues = regionVenues.filter(v => v.area === areaFilter);
          list = list.filter(v => areaVenues.some(av => av.id === v.venueId));
        } else {
          list = list.filter(v => regionVenues.some(rv => rv.id === v.venueId));
        }
      }

      const c=$('content');

      // Show skeleton loader briefly (similar to venues and statistics)
      showSkeletons(c, 4);

      setTimeout(() => {
        // Calculate perfect venues from visited venues
        const perfectVenueIds = new Set();
        list.forEach(v => {
          const venue = venues.find(ven => ven.id === v.venueId);
          if(venue && perfect(venue)) {
            perfectVenueIds.add(v.venueId);
          }
        });

        // Calculate toggle stats
        const toggleStats = {
          lightVisibility: 0,
          coolingDevice: 0,
          standardPOSM: 0,
          correctMenu: 0,
          promo: 0,
          iceColdServe: 0,
          staffTraining: 0
        };

        const visitedVenueIds = new Set(list.map(v => v.venueId));
        visitedVenueIds.forEach(venueId => {
          const venue = venues.find(v => v.id === venueId);
          if(venue) {
            if(venue.lightVisibility) toggleStats.lightVisibility++;
            if(venue.coolingDevice) toggleStats.coolingDevice++;
            if(venue.standardPOSM) toggleStats.standardPOSM++;
            if(venue.correctMenu) toggleStats.correctMenu++;
            if(venue.promo) toggleStats.promo++;
            if(venue.iceColdServe) toggleStats.iceColdServe++;
            if(venue.staffTraining) toggleStats.staffTraining++;
          }
        });

        const s={total:list.length,perfectVenues:perfectVenueIds.size};
        let html=`<div class="sum"><div class="sumg">`+
        `<div class="sumi"><div class="sul">Total Visits</div><div class="suv count-up">${s.total}</div></div>`+
        `<div class="sumi"><div class="sul">Perfect Venues</div><div class="suv count-up">${s.perfectVenues}</div></div>`+
        `</div></div>`+
        `<div class="info" style="border:none;margin-top:12px">`+
        `<h3 style="font-size:14px;font-weight:700;margin-bottom:12px;color:var(--fg)">Venue Status Overview</h3>`+
        `<div style="display:flex;flex-direction:column;gap:8px">`+
        `<div class="row2"><span>Light Visibility</span><strong style="color:var(--accent)">${toggleStats.lightVisibility}</strong></div>`+
        `<div class="row2"><span>Cooling Device</span><strong style="color:var(--accent)">${toggleStats.coolingDevice}</strong></div>`+
        `<div class="row2"><span>Standard POSM</span><strong style="color:var(--accent)">${toggleStats.standardPOSM}</strong></div>`+
        `<div class="row2"><span>Correct Menu</span><strong style="color:var(--accent)">${toggleStats.correctMenu}</strong></div>`+
        `<div class="row2"><span>Promo Active</span><strong style="color:var(--accent)">${toggleStats.promo}</strong></div>`+
        `<div class="row2"><span>Ice-cold Serve</span><strong style="color:var(--accent)">${toggleStats.iceColdServe}</strong></div>`+
        `<div class="row2"><span>Staff Training</span><strong style="color:var(--accent)">${toggleStats.staffTraining}</strong></div>`+
        `</div></div><div class="list">`;

        let cardIndex = 0;
        list.forEach(v=>{
          const ven=venues.find(x=>x.id===v.venueId);
          if(!ven) return;
          const ambassadorInfo = userRole === 'manager' && v.ambassadorName ?
            `<div style="font-size:12px;color:var(--accent);font-weight:600;margin-bottom:4px">${v.ambassadorName}</div>` : '';
          html+=`<div class="card visit-card-animated" data-id="${ven.id}" style="animation-delay:${cardIndex * 0.05}s">`+
            ambassadorInfo +
            `<div style="font-size:11px;color:#999;display:flex;gap:6px;align-items:center"><span class="icon">${ICONS.calendar}</span>${v.date}</div>`+
            `<div class="name">${esc(ven.name)}</div>`+
            `<div class="loc"><span class="icon">${ICONS.location}</span>${esc(ven.area)}, ${esc(ven.region.charAt(0).toUpperCase() + ven.region.slice(1).replace('-', ' '))}</div>`+
            `<div style="margin-top:8px;font-size:13px;color:#666">${(v.actions||[]).map(a=>`<span class="icon">${ICONS.check}</span> ${esc(a)}`).join('<br>')}</div>`+
            (v.notes? `<div style="margin-top:8px;padding:8px;background:#f5f5f5;border-radius:6px;font-size:12px"><span class="icon">${ICONS.note}</span> ${esc(v.notes)}</div>`:'')+
          `</div>`;
          cardIndex++;
        });
        html+='</div>';
        c.innerHTML=html;
        qsa('.card',c).forEach(el=>el.addEventListener('click',()=>openDetail(Number(el.dataset.id))));
        animateCounters();
      }, 150);
    }

    // Statistics
    function renderStatFilters(){
      const f=$('filters');
      // Managers can see all regions
      if(userRole === 'manager') {
        const regions = [
          {value: 'bali', label: 'Bali'},
          {value: 'west-java', label: 'West Java'},
          {value: 'east-java', label: 'East Java'}
        ];

        f.innerHTML=`
        <div class="filter-row">
          <div class="filter-col">
            <div class="filter-label">Region</div>
            <select class="sel" id="statRegionFilter" style="width:100%">
              <option value="all">All Regions</option>
              ${regions.map(r=>`<option value="${r.value}">${r.label}</option>`).join('')}
            </select>
          </div>
          <div class="filter-col">
            <div class="filter-label">Location</div>
            <select class="sel" id="statLocationFilter" style="width:100%">
              <option value="">All Locations</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-col">
            <select class="sel" id="sCat" style="width:100%">
              <option value="">All Categories</option>
              <option value="must-win-image">Must Win Image</option>
              <option value="must-win-commercial">Must Win Commercial</option>
              <option value="high-importance">High Importance</option>
            </select>
          </div>
          <div class="filter-col">
            <select class="sel" id="sPerf" style="width:100%">
              <option value="">All Outlets</option>
              <option value="perfect">Perfect Outlets Only</option>
              <option value="not">Non-Perfect</option>
            </select>
          </div>
        </div>`;

        // Setup event listeners
        setTimeout(()=>{
          const locationsByRegion = {
            'bali': ['Seminyak', 'Canggu', 'Uluwatu'],
            'west-java': ['Jakarta', 'Bandung'],
            'east-java': ['Surabaya', 'Malang']
          };

          const statRegionFilter = $('statRegionFilter');
          const statLocationFilter = $('statLocationFilter');

          if(statRegionFilter) {
            statRegionFilter.addEventListener('change',()=>{
              const region = statRegionFilter.value;

              // Update location dropdown
              if(region === 'all') {
                statLocationFilter.innerHTML = '<option value="">All Locations</option>';
              } else {
                const locations = locationsByRegion[region] || [];
                statLocationFilter.innerHTML = '<option value="">All Locations</option>' +
                  locations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
              }
              statLocationFilter.value = '';

              renderStats();
            });
          }

          ['statLocationFilter','sCat','sPerf'].forEach(id=>$(id)?.addEventListener('change',renderStats));
        });
      } else {
        // Ambassadors see only their region
        f.innerHTML=`
        <div class="row"><select class="sel" id="sCat"><option value="">All Categories</option><option value="must-win-image">Must Win Image</option><option value="must-win-commercial">Must Win Commercial</option><option value="high-importance">High Importance</option></select>
        <select class="sel" id="sPerf"><option value="">All Outlets</option><option value="perfect">Perfect Outlets Only</option><option value="not">Non-Perfect</option></select></div>`;
        ['sCat','sPerf'].forEach(id=>$(id)?.addEventListener('change',renderStats));
      }
    }
    function renderStats(){
      const c=$('content');
      const region=$('statRegionFilter')?.value||'all';
      const location=$('statLocationFilter')?.value||'';
      const cat=$('sCat')?.value||'',pf=$('sPerf')?.value||'';
      let arr=venues.slice();

      // Filter based on user role first
      if(userRole === 'ambassador') {
        arr = arr.filter(v => v.region === userRegion);
      } else if(userRole === 'manager'){
        // Managers can filter by region and location
        if(region !== 'all') {
          arr = arr.filter(v => v.region === region);
        }
        if(location) {
          arr = arr.filter(v => v.area === location);
        }
      }

      if(cat) arr=arr.filter(v=>v.category===cat);
      if(pf==='perfect') arr=arr.filter(perfect);
      else if(pf==='not') arr=arr.filter(v=>!perfect(v));

      const total=arr.length;
      if(!total){
        c.innerHTML='<p style="text-align:center;color:#999;padding:40px">No venues match the selected filters</p>';
        return;
      }

      const p=arr.filter(perfect).length;
      const avgShot=Math.round(arr.reduce((s,v)=>s+(v.shotPrice||0),0)/total);
      const avgBottle=Math.round(arr.reduce((s,v)=>s+(v.bottlePrice||0),0)/total);
      let html=`<div class="sum"><div class="sumg">`+
        `<div class="sumi"><div class="sul">Perfect Outlets</div><div class="suv count-up">${p}</div></div>`+
        `<div class="sumi"><div class="sul">Total Venues</div><div class="suv count-up">${total}</div></div>`+
        `<div class="sumi"><div class="sul">Avg Shot Price</div><div class="suv count-up">${fmtIDR.format(avgShot)}</div></div>`+
        `<div class="sumi"><div class="sul">Avg Bottle Price</div><div class="suv count-up">${fmtIDR.format(avgBottle)}</div></div>`+
      `</div></div>`;


      // Performance reports section removed - keeping only core statistics metrics

      const k=[ ['Contracts','contract'],['Custom Branding','customBranding'],['Light Visibility','lightVisibility'],['Cooling Device','coolingDevice'],['Standard POSM','standardPOSM'],['Correct Menu','correctMenu'],['Promo Active','promo'],['Ice-cold Serve','iceColdServe'],['Staff Training','staffTraining'] ]; html+='<div class="list">'; k.forEach(([lab,key])=>{ const val=arr.filter(v=>v[key]).length; const perc=Math.round((val/total)*100); const color=perc>=80?'var(--electric)':perc>=50?'#ffa726':'#ef5350';
        html+=`<div class="card" style="position:relative;padding:20px">`+
          `<div style="display:flex;align-items:center;gap:16px">`+
            `<div style="position:relative;width:60px;height:60px">`+
              `<svg class="progress-ring" viewBox="0 0 60 60">`+
                `<circle cx="30" cy="30" r="26" stroke="#e0e0e0" stroke-width="4" fill="none"/>`+
                `<circle class="progress-ring-circle" cx="30" cy="30" r="26" stroke="${color}" stroke-dasharray="${163.4}" stroke-dashoffset="${163.4*(1-perc/100)}"/>`+
              `</svg>`+
              `<div class="progress-label">${perc}%</div>`+
            `</div>`+
            `<div style="flex:1">`+
              `<div style="font-weight:700;color:var(--fg);font-size:14px">${lab}</div>`+
              `<div style="font-size:12px;color:#999;margin-top:2px">${val} of ${total} venues</div>`+
            `</div>`+
          `</div>`+
        `</div>`; }); html+='</div>';

      // Add Team Leaderboard for managers only (with filters)
      if(userRole === 'manager') {
        // Filter visits based on current statistics filters
        const filteredVisits = visits.filter(v => {
          const venue = venues.find(ven => ven.id === v.venueId);
          if(!venue) return false;

          // Apply region filter
          const region=$('statRegionFilter')?.value||'all';
          const location=$('statLocationFilter')?.value||'';

          if(region !== 'all' && venue.region !== region) return false;
          if(location && venue.area !== location) return false;

          return true;
        });

        html += renderTeamLeaderboard(filteredVisits);
      }

      c.innerHTML=html; animateCounters(); }

    // Detail
    function openDetail(id){
      current=id;
      const v=venues.find(x=>x.id===id);
      if(!v) return;

      // Debug La Favela specifically when opening detail
      if (v.name === 'La Favela') {
        console.log('Opening La Favela detail view:', {
          correctMenu: v.correctMenu,
          promo: v.promo,
          allToggles: {
            lightVisibility: v.lightVisibility,
            coolingDevice: v.coolingDevice,
            standardPOSM: v.standardPOSM,
            correctMenu: v.correctMenu,
            promo: v.promo,
            iceColdServe: v.iceColdServe,
            staffTraining: v.staffTraining
          },
          isPerfect: perfect(v)
        });
      }

      $('dName').textContent=v.name;
      $('dRegion').textContent=v.region.charAt(0).toUpperCase() + v.region.slice(1).replace('-', ' ');
      $('dArea').textContent=v.area;
      $('dType').textContent=v.venueType.charAt(0).toUpperCase() + v.venueType.slice(1);
      $('dCat').textContent=v.category.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      $('dShot').textContent=v.shotPrice?fmtIDR.format(v.shotPrice):'-';
      $('dBottle').textContent=v.bottlePrice?fmtIDR.format(v.bottlePrice):'-';
      $('dSales').textContent=v.avgMonthlySales?fmtInt.format(v.avgMonthlySales)+' bottles':'-';

      // Only show Create Visit Report button for ambassadors
      const buttonContainer = $('visitButtonContainer');
      if(userRole === 'ambassador') {
        buttonContainer.innerHTML = '<button class="btn" id="openVisit"><span class="icon" data-i="edit"></span>Create Visit Report</button>';
        initIcons();
        // Re-attach the event listener
        $('openVisit').addEventListener('click',()=>{
          fromDetail=true;
          show('visit');
          $('visitSel').style.display='none';
          $('selVenue').innerHTML=`<option value="${current}">Current: ${esc(venues.find(v=>v.id===current).name)}</option>`;
          buildToggles();
        });
      } else {
        buttonContainer.innerHTML = '';
      }

      const pairs=[
        ['Contract',v.contract],
        ['Custom Branding',v.customBranding],
        ['Light Visibility',v.lightVisibility],
        ['Cooling Device',v.coolingDevice],
        ['Standard POSM',v.standardPOSM],
        ['Correct Menu',v.correctMenu],
        ['Promo Active',v.promo],
        ['Ice-cold Serve',v.iceColdServe],
        ['Staff Training',v.staffTraining]
      ];

      $('dStatus').innerHTML=pairs.map(([l,val])=>`<div class="tile ${val?'y':'n'}">${val?`<span class="icon">${ICONS.ok}</span>`:`<span class="icon">${ICONS.x}</span>`} ${l}</div>`).join(''); const hist=visits.filter(r=>r.venueId===id).sort((a,b)=>b.dateObj-a.dateObj); $('dHist').innerHTML= hist.length? hist.map(h=>`<div class="card">`+
        `<div style="font-size:11px;color:#999;display:flex;gap:6px;align-items:center"><span class="icon">${ICONS.calendar}</span>${h.date}</div>`+
        `<div class="loc" style="margin-top:4px"><span class="icon">${ICONS.user}</span>${esc(h.user)}</div>`+
        (h.actions?.length? `<div style="margin-top:6px;font-size:13px">${h.actions.map(a=>{
          const isDeactivation = a.includes('deactivated');
          const color = isDeactivation ? '#c62828' : '#2e7d32';
          return `<div style="color:${color};margin:2px 0">${esc(a)}</div>`;
        }).join('')}</div>`:'')+
        (h.notes? `<div style="margin-top:8px;padding:8px;background:#f5f5f5;border-radius:6px;font-size:12px"><span class="icon">${ICONS.note}</span> ${esc(h.notes)}</div>`:'')+
      `</div>`).join('') : '<p style="padding:12px;color:#777">No history yet</p>'; qsa('.tab').forEach(t=>t.classList.remove('active')); qsa('[id^=tab-]').forEach(e=>e.style.display='none'); qsa('.tab')[0].classList.add('active'); $('tab-info').style.display='block'; show('detail'); }
    qsa('.tab').forEach(t=>t.addEventListener('click',()=>{ qsa('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); qsa('[id^=tab-]').forEach(e=>e.style.display='none'); $(`tab-${t.dataset.t}`).style.display='block'; }));

    // Visit helpers
    function fillVisitSelect(){
      const s=$('selVenue');
      s.innerHTML='<option value="">Select from list...</option>'+venues.map(v=>`<option value="${v.id}">${esc(v.name)}</option>`).join('');
      s.addEventListener('change', function() {
        const venueId = Number(this.value);
        if (venueId) {
          const venue = venues.find(v => v.id === venueId);
          if (venue) {
            $('currentShot').innerHTML = `Current: <strong>${venue.shotPrice ? fmtIDR.format(venue.shotPrice) : 'Not set'}</strong>`;
            $('currentBottle').innerHTML = `Current: <strong>${venue.bottlePrice ? fmtIDR.format(venue.bottlePrice) : 'Not set'}</strong>`;
            $('currentSales').innerHTML = `Current: <strong>${venue.avgMonthlySales ? venue.avgMonthlySales + ' bottles' : 'Not set'}</strong>`;
            // Update toggle states based on venue
            qsa('.toggle-switch').forEach(toggle => {
              const key = toggle.getAttribute('data-key');
              if (venue[key]) {
                toggle.classList.add('on');
              } else {
                toggle.classList.remove('on');
              }
            });
          }
        } else {
          $('currentShot').innerHTML = 'Current: <strong>Select a venue</strong>';
          $('currentBottle').innerHTML = 'Current: <strong>Select a venue</strong>';
          $('currentSales').innerHTML = 'Current: <strong>Select a venue</strong>';
        }
      });
    }
    function buildToggles(){
      const keys=[
        {key:'contract',label:'Contract Signed'},
        {key:'customBranding',label:'Custom Branding'},
        {key:'lightVisibility',label:'Light Visibility'},
        {key:'coolingDevice',label:'Cooling Device'},
        {key:'standardPOSM',label:'Standard POSM'},
        {key:'correctMenu',label:'Correct Menu'},
        {key:'promo',label:'Promo Active'},
        {key:'iceColdServe',label:'Ice-cold Serve'},
        {key:'staffTraining',label:'Staff Training'}
      ];
      $('toggles').innerHTML=keys.map(k=>
        `<div class="toggle-item">
          <span class="toggle-label">${k.label}</span>
          <div class="toggle-switch" data-key="${k.key}"></div>
        </div>`
      ).join('');
      qsa('.toggle-switch').forEach(t=>t.addEventListener('click',function(){
        this.classList.toggle('on');

        // Check perfect venue status and update if needed
        const vId = Number($('selVenue').value || current || 0);
        if(vId) {
          const venue = venues.find(x => x.id === vId);
          if(venue) {
            // Get current states of all toggles
            const states = {};
            qsa('.toggle-switch').forEach(toggle => {
              const key = toggle.getAttribute('data-key');
              states[key] = toggle.classList.contains('on');
            });

            // Check if venue becomes perfect (ALL toggles must be on)
            const isPerfect = states.lightVisibility && states.coolingDevice &&
                            states.standardPOSM && states.correctMenu &&
                            states.promo && states.iceColdServe && states.staffTraining;

            // If any toggle is OFF, ensure perfect status is removed
            if(!this.classList.contains('on')) {
              // One toggle was turned off, so cannot be perfect
              console.log('Toggle turned off - removing perfect status');
            } else if(isPerfect) {
              console.log('All toggles ON - perfect venue achieved!');
            }
          }
        }
      }));
      // Clear notes field
      if($('notes')) $('notes').value = '';
      // Clear price inputs
      if($('pShot')) $('pShot').value = '';
      if($('pBottle')) $('pBottle').value = '';
      if($('pSales')) $('pSales').value = '';
      // Set initial states if venue is selected
      if(current) {
        const venue = venues.find(v => v.id === current);
        if(venue) {
          qsa('.toggle-switch').forEach(toggle => {
            const key = toggle.getAttribute('data-key');
            if(venue[key]) toggle.classList.add('on');
          });
          // Update price displays
          $('currentShot').innerHTML = `Current: <strong>${venue.shotPrice ? fmtIDR.format(venue.shotPrice) : 'Not set'}</strong>`;
          $('currentBottle').innerHTML = `Current: <strong>${venue.bottlePrice ? fmtIDR.format(venue.bottlePrice) : 'Not set'}</strong>`;
          $('currentSales').innerHTML = `Current: <strong>${venue.avgMonthlySales ? venue.avgMonthlySales + ' bottles' : 'Not set'}</strong>`;
        }
      }
    }
    // Actions removed - using only status toggles now
    function buildActions(){ /* Deprecated - using venue status toggles instead */ }

    // Settings tab
    function renderSettings(){
      const f=$('filters');
      const c=$('content');
      f.innerHTML = ''; // Clear filters for settings

      c.innerHTML = `
      <div class="settings-section">
        <div class="settings-section-title">
          <span class="icon">${ICONS.user}</span>
          Profile Information
        </div>
        <div class="settings-row">
          <span class="settings-label">Name</span>
          <input class="settings-input" id="userName" value="${user?.name || 'Demo User'}" />
        </div>
        <div class="settings-row">
          <span class="settings-label">Role</span>
          <span class="settings-value">${userRole === 'manager' ? 'Manager' : 'Brand Ambassador'}</span>
        </div>
        ${userRole === 'ambassador' ? `
          <div class="settings-row">
            <span class="settings-label">Assigned Region</span>
            <span class="settings-value">${userRegion.charAt(0).toUpperCase() + userRegion.slice(1).replace('-', ' ')}</span>
          </div>
        ` : ''}
        <div class="settings-row">
          <span class="settings-label">Email</span>
          <span class="settings-value">${user?.email || 'demo@jager.com'}</span>
        </div>
        <div style="margin-top:16px">
          <button class="btn btn-icon-gradient" id="saveNameBtn">
            <span class="icon">${ICONS.save}</span>Save Changes
          </button>
        </div>
      </div>

      <div class="settings-section" style="margin-top:16px">
        <div class="settings-section-title">
          <span class="icon">${ICONS.settings}</span>
          App Information
        </div>
        <div class="settings-row">
          <span class="settings-label">Version</span>
          <span class="settings-value">1.0.0 (MVP)</span>
        </div>
        <div class="settings-row">
          <span class="settings-label">Data Storage</span>
          <span class="settings-value">Local (Demo Mode)</span>
        </div>
        <div class="settings-row">
          <span class="settings-label">Build</span>
          <span class="settings-value">September 2025</span>
        </div>
        <div class="settings-footer">
          <div style="font-size:12px;color:#666;text-align:center;margin-bottom:12px">
            This is a demo version using local storage.<br>No data is sent to servers.
          </div>
          <button class="btn btn-signout" id="logoutBtn">
            <span class="icon">${ICONS.arrowLeft}</span>Sign Out
          </button>
        </div>
      </div>`;

      // Add event listener for save name
      $('saveNameBtn').addEventListener('click', () => {
        const newName = $('userName').value.trim();
        if(newName) {
          user.name = newName;
          save();
          showToast('Name updated successfully', 'success');
        }
      });

      // Add event listener for logout
      $('logoutBtn').addEventListener('click', () => {
        if(confirm('Are you sure you want to sign out?')) {
          user = null;
          userRole = 'ambassador';
          userRegion = '';
          save();
          show('login');
          showToast('Signed out successfully', 'success');
        }
      });
    }

    // Removed Reports tab functionality

    function logout(){
      if(confirm('Are you sure you want to sign out?')){
        user = null;
        selectedRegion = 'all';
        save();
        show('login');
        showToast('Signed out successfully', 'success');
      }
    }

    // Add / Save
    function addVenue(){
      const name=sanitizeInput($('vName').value.trim());
      const loc=$('vLoc').value;
      if(!name||!loc){
        showToast('Please enter name and location', 'error');
        return;
      }
      const [region,area]=loc.split('|');
      const id=venues.reduce((m,v)=>Math.max(m,v.id),0)+1;
      const v={
        id,
        name,
        region,
        area,
        category:$('vCat').value,
        venueType:$('vType').value,
        shotPrice:0,
        bottlePrice:0,
        avgMonthlySales:0,
        contract:false,
        customBranding:false,
        lightVisibility:false,
        coolingDevice:false,
        standardPOSM:false,
        correctMenu:false,
        promo:false,
        iceColdServe:false,
        staffTraining:false
      };
      venues.push(v);
      save();
      showToast('Venue added successfully!', 'success');
      show('main');
      setTab('venues');
    }
    function saveVisit(){
      const vid=Number($('selVenue').value||current||0);
      if(!vid){ showToast('Please select a venue', 'error'); return;}
      const v=venues.find(x=>x.id===vid);
      if(!v){ showToast('Venue not found', 'error'); return; }

      // Update prices if provided with validation
      const shot=Number($('pShot').value)||null;
      const bottle=Number($('pBottle').value)||null;
      const sales=Number($('pSales').value)||null;

      // Validate prices
      if(shot && !validatePrice(shot)) {
        showToast('Invalid shot price. Please enter a valid amount.', 'error');
        return;
      }
      if(bottle && !validatePrice(bottle)) {
        showToast('Invalid bottle price. Please enter a valid amount.', 'error');
        return;
      }
      if(sales && (sales < 0 || sales > 10000)) {
        showToast('Invalid sales amount. Please enter a value between 0 and 10000.', 'error');
        return;
      }

      if(shot) v.shotPrice=shot;
      if(bottle) v.bottlePrice=bottle;
      if(sales) v.avgMonthlySales=sales;

      // Track what changed
      const oldStates = {};
      const newStates = {};
      const changes = [];

      // Check if venue was perfect BEFORE updating
      const wasPerfect = perfect(v);

      qsa('.toggle-switch').forEach(t=>{
        const k=t.getAttribute('data-key');
        const label = t.parentElement.querySelector('.toggle-label').textContent;
        oldStates[k] = v[k];
        newStates[k] = t.classList.contains('on');

        // Track changes
        if(oldStates[k] !== newStates[k]){
          if(newStates[k]){
            changes.push(`${label} activated`);
          } else {
            changes.push(`${label} deactivated`);
          }
        }
      });

      // Ensure the venue object in the venues array is properly updated
      // Find the venue index to update the actual array element
      const venueIndex = venues.findIndex(x => x.id === vid);
      if(venueIndex !== -1) {
        // Update each toggle property explicitly in the venues array
        Object.keys(newStates).forEach(k => {
          venues[venueIndex][k] = newStates[k];
        });
        // Price fields were already updated on the v object earlier
        // Ensure they're also updated in the array
        venues[venueIndex].shotPrice = v.shotPrice;
        venues[venueIndex].bottlePrice = v.bottlePrice;
        venues[venueIndex].avgMonthlySales = v.avgMonthlySales;
      } else {
        // If venue not found in array (shouldn't happen), update the v object directly
        Object.keys(newStates).forEach(k => {
          v[k] = newStates[k];
        });
      }

      // Check perfect venue logic AFTER updates - ALL 7 toggles must be ON
      const isPerfect = perfect(venueIndex !== -1 ? venues[venueIndex] : v);

      // Only add perfect status message if it's a new achievement
      if(isPerfect && !wasPerfect){
        changes.push('Perfect Outlet status achieved');
      } else if(wasPerfect && !isPerfect){
        changes.push('Perfect Outlet status lost');
      }

      // Add price changes if any
      if(shot && v.shotPrice !== shot) changes.push(`Shot price updated to ${fmtIDR.format(shot)}`);
      if(bottle && v.bottlePrice !== bottle) changes.push(`Bottle price updated to ${fmtIDR.format(bottle)}`);
      if(sales && v.avgMonthlySales !== sales) changes.push(`Monthly sales updated to ${sales} bottles`);

      const notes=$('notes').value.trim();
      const now=new Date();
      const rec={
        id:(visits.reduce((m,r)=>Math.max(m,r.id),0)+1),
        venueId:vid,
        date:now.toISOString().split('T')[0],
        dateObj:new Date(now.getFullYear(),now.getMonth(),now.getDate(),12),
        user:(user?.realName||user?.name||'Demo User'),
        ambassadorName: user?.name || 'Unknown Ambassador',
        ambassadorRegion: user?.region || 'Unknown',
        actions:changes.length > 0 ? changes : ['Routine check - no changes'],
        notes
      };
      visits.unshift(rec);
      save();

      // Show appropriate toast based on perfect status change
      if(isPerfect && !wasPerfect){
        showToast('🌟 Perfect Outlet achieved!', 'success');
      } else if(wasPerfect && !isPerfect){
        showToast('⚠️ Perfect Outlet status lost', 'warning');
      } else if(isPerfect){
        showToast('✅ Visit saved - Perfect Outlet maintained!', 'success');
      } else {
        showToast('Visit report saved successfully!', 'success');
      }

      // Refresh the appropriate view to show updated perfect status
      if(fromDetail){
        openDetail(vid);
      } else {
        // Stay on the venues tab and refresh the list with updated data
        // Force a fresh render to ensure badges are updated immediately
        setTimeout(() => {
          renderVenues();
        }, 50); // Small delay to ensure DOM is ready and state is saved
      }
    }

    // Nav & events
    function setupNav(){
      qsa('#nav .it').forEach(n=>n.addEventListener('click',()=>setTab(n.dataset.tab)));
      $('fab').addEventListener('click',()=>{
        if(tab==='venues'){
          $('vLoc').innerHTML=locOptions.filter(o=>o.v).map(o=>`<option value="${o.v}">${o.l}</option>`).join('');
          show('add');
        } else if(tab==='visits'){
          fromDetail=false;
          show('visit');
          fillVisitSelect();
          buildToggles();
        }
      });
      $('backDetail').addEventListener('click',()=>show('main'));
      $('backAdd').addEventListener('click',()=>show('main'));
      $('backVisit').addEventListener('click',()=>{
        if(fromDetail&&current){ openDetail(current); } else { show('main'); }
      });
      // Removed static openVisit listener - now handled dynamically in openDetail
      $('addBtn').addEventListener('click',addVenue);
      $('saveVisit').addEventListener('click',saveVisit);
    }

    // Icons injection (safe, after DOM is ready)
    function initIcons(){ qsa('[data-i]').forEach(el=>{ el.innerHTML=ICONS[el.getAttribute('data-i')]||''; }); const f=$('fab'); if(f) f.innerHTML=ICONS.plus; }

    // Login
    
    function login(){
      console.log('Login function called');
      try {
        const btn = $('loginBtn');
        const emailInput = $('email').value.trim();
        const passInput = $('pass').value;

        // Validate email format
        if (!validateEmail(emailInput)) {
          showToast('Please enter a valid email address', 'error');
          return;
        }

        // Sanitize inputs
        const sanitizedEmail = sanitizeInput(emailInput).toLowerCase();

        // Detect role and region based on email
        if(sanitizedEmail.includes('manager')) {
          userRole = 'manager';
          userRegion = 'all';
        } else {
          userRole = 'ambassador';
          // Extract region from email (e.g., john.bali@ -> bali)
          const emailParts = sanitizedEmail.split('@')[0].split('.');
          if(emailParts.length > 1) {
            const region = emailParts[emailParts.length - 1];
            // Map email region to actual region
            if(region === 'bali') userRegion = 'bali';
            else if(region === 'jakarta') userRegion = 'west-java';
            else if(region === 'bandung') userRegion = 'west-java';
            else if(region === 'surabaya') userRegion = 'east-java';
            else if(region === 'malang') userRegion = 'east-java';
            else userRegion = 'bali'; // Default region for ambassadors
          } else {
            userRegion = 'bali'; // Default region
          }
        }

        console.log('Processing login:', sanitizedEmail, 'Role:', userRole, 'Region:', userRegion);
        btn.disabled = true;
        btn.innerHTML = '<span class="icon">'+ICONS.user+'</span><span>Authenticating...</span>';

        // Simulate authentication delay
        setTimeout(() => {
          console.log('Authentication timeout executing...');
          const userName = sanitizedEmail.split('@')[0].split('.').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' ');
          user={name:userName,realName:userName,email:sanitizedEmail,role:userRole,region:userRegion};
          const had=load();
          console.log('Data loaded from storage:', had);
          if(!had) {
            console.log('No existing data, seeding...');
            seedEnhanced();
          }

          // Fix data integrity after loading
          fixDataIntegrity();

          // Set selectedRegion based on user role
          if(userRole === 'ambassador') {
            selectedRegion = userRegion;
          }

          btn.disabled = false;
          btn.innerHTML = '<span class="icon">'+ICONS.user+'</span><span>Sign In</span>';
          show('main');

          // Update navigation based on role
          setupRoleBasedNav();

          // Set initial tab based on role
          // Both roles start on venues tab
          setTab('venues');

          // Show welcome message with role
          const roleText = userRole === 'manager' ? 'Manager Mode' : `Ambassador - ${userRegion.charAt(0).toUpperCase() + userRegion.slice(1).replace('-',' ')}`;

          // Update role indicator
          const roleIndicator = $('roleIndicator');
          if(roleIndicator) {
            roleIndicator.textContent = roleText;
          }

          setTimeout(() => showToast(`Welcome ${userName} (${roleText})`), 300);
        }, 800);
      } catch(e) {
        console.error('Login error:', e);
        showToast('Login failed. Please try again.', 'error');
        $('loginBtn').disabled = false;
        $('loginBtn').innerHTML = '<span class="icon">'+ICONS.user+'</span><span>Sign In</span>';
      }
    }

    // Setup navigation based on user role
    function setupRoleBasedNav(){
      const nav = $('nav');
      // Both roles have the same navigation now
      nav.innerHTML = `
        <div class="it active" data-tab="venues"><span class="icon" data-i="location"></span>Venues</div>
        <div class="it" data-tab="visits"><span class="icon" data-i="clipboard"></span>Visits</div>
        <div class="it" data-tab="statistics"><span class="icon" data-i="chart"></span>Statistics</div>
        <div class="it" data-tab="settings"><span class="icon" data-i="settings"></span>Settings</div>
      `;
      // Re-init icons and event listeners
      initIcons();
      qsa('#nav .it').forEach(n=>n.addEventListener('click',()=>setTab(n.dataset.tab)));
    }

    // Init
    function init(){
      console.log('Initializing app...');
      try {
        setupNav();
        initIcons();

        // Setup login handlers
        const loginBtn = $('loginBtn');
        if(loginBtn) {
          loginBtn.addEventListener('click', login);
          console.log('Login button handler attached');
        }

        // Quick login buttons
        const managerQuickLogin = $('managerQuickLogin');
        if(managerQuickLogin) {
          managerQuickLogin.addEventListener('click', ()=>{
            // Animate button click
            managerQuickLogin.style.transform = 'scale(0.95)';
            setTimeout(()=>managerQuickLogin.style.transform = '', 200);

            // Auto-login as manager
            $('email').value = 'manager@jager.com';
            $('pass').value = 'password';
            setTimeout(login, 300);
          });
        }

        const ambassadorQuickLogin = $('ambassadorQuickLogin');
        if(ambassadorQuickLogin) {
          ambassadorQuickLogin.addEventListener('click', ()=>{
            // Animate button click
            ambassadorQuickLogin.style.transform = 'scale(0.95)';
            setTimeout(()=>ambassadorQuickLogin.style.transform = '', 200);

            // Auto-login as ambassador (John Smith from Bali)
            $('email').value = 'john.bali@jager.com';
            $('pass').value = 'password';
            setTimeout(login, 300);
          });
        }

        // Custom login collapsible
        const customLoginSection = $('customLoginSection');
        if(customLoginSection) {
          const header = customLoginSection.querySelector('.collapsible-header');
          if(header) {
            header.addEventListener('click', ()=>{
              customLoginSection.classList.toggle('open');
            });
          }
        }

        const passField = $('pass');
        if(passField) {
          passField.addEventListener('keydown',e=>{ if(e.key==='Enter') login(); });
        }

        console.log('App initialized successfully');
      } catch(e) {
        console.error('Init error:', e);
      }
    }

    // Ensure DOM is ready
    if(document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Debug function to check La Favela's state
    function debugLaFavela() {
      const laFavela = venues.find(v => v.name === 'La Favela');
      if (laFavela) {
        console.log('La Favela current state:');
        console.log('ID:', laFavela.id);
        console.log('Light Visibility:', laFavela.lightVisibility);
        console.log('Cooling Device:', laFavela.coolingDevice);
        console.log('Standard POSM:', laFavela.standardPOSM);
        console.log('Correct Menu:', laFavela.correctMenu);
        console.log('Promo:', laFavela.promo);
        console.log('Ice-cold Serve:', laFavela.iceColdServe);
        console.log('Staff Training:', laFavela.staffTraining);
        console.log('Is Perfect?', perfect(laFavela));

        // Fix La Favela's data if it's incorrectly set to perfect
        if (laFavela.correctMenu !== false || laFavela.promo !== false) {
          console.warn('La Favela has incorrect toggle values! Fixing...');
          laFavela.correctMenu = false;
          laFavela.promo = false;
          save();
          console.log('La Favela data fixed and saved.');
          showToast('Fixed La Favela venue data', 'success');
          // Re-render venues if on venues tab
          if (tab === 'venues') {
            renderVenues();
          }
        }
      }
    }

    // Fix data integrity on load
    function fixDataIntegrity() {
      // Check La Favela specifically
      const laFavela = venues.find(v => v.name === 'La Favela');
      if (laFavela) {
        // According to seedEnhanced, La Favela should have correctMenu:false and promo:false
        if (laFavela.correctMenu !== false || laFavela.promo !== false) {
          console.warn('Data integrity issue detected: La Favela has incorrect values');
          laFavela.correctMenu = false;
          laFavela.promo = false;
          save();
          console.log('Data integrity fixed for La Favela');
        }
      }

      // Validate all venues' perfect status
      let fixedCount = 0;
      venues.forEach(v => {
        const shouldBePerfect = v.lightVisibility && v.coolingDevice && v.standardPOSM &&
                               v.correctMenu && v.promo && v.iceColdServe && v.staffTraining;
        const isPerfect = perfect(v);
        if (shouldBePerfect !== isPerfect) {
          console.error('Perfect status mismatch for venue:', v.name);
          fixedCount++;
        }
      });

      if (fixedCount > 0) {
        console.log(`Fixed ${fixedCount} venues with perfect status issues`);
      }
    }

    // Optional: developer smoke-tests (disabled by default to avoid auto navigation)
    function runTests(){ try{
      show('login'); login(); console.assert($('main').classList.contains('active'),'Login opens main');
      setTab('visits'); console.assert($('content').innerHTML.includes('Total Visits'),'Visits summary');
      setTab('statistics'); console.assert($('content').innerHTML.includes('Perfect Outlets'),'Stats render');
      setTab('venues'); const before=venues.length; $('fab').click(); $('vName').value='Test Venue'; const loc=$('vLoc'); if(loc.options.length){ loc.value=loc.options[0].value;} $('addBtn').click(); console.assert(venues.length===before+1,'Venue added');
    }catch(e){ console.error('[tests failed]',e); }
    }
    // runTests(); // Disabled for production

    // Reset La Favela to its correct state
    function resetLaFavela() {
      const laFavela = venues.find(v => v.name === 'La Favela');
      if (laFavela) {
        console.log('Resetting La Favela to correct state...');
        // According to seedEnhanced, La Favela should have these exact values
        laFavela.correctMenu = false;
        laFavela.promo = false;
        laFavela.lightVisibility = true;
        laFavela.coolingDevice = true;
        laFavela.standardPOSM = true;
        laFavela.iceColdServe = true;
        laFavela.staffTraining = true;

        save();
        console.log('La Favela reset complete. Perfect status:', perfect(laFavela));

        // Re-render if on venues tab
        if (tab === 'venues') {
          renderVenues();
          showToast('La Favela data has been reset', 'success');
        }
      } else {
        console.log('La Favela not found in venues');
      }
    }

    // Clear all localStorage and reset app
    function clearAllData() {
      if (confirm('This will clear all data and reset the app. Are you sure?')) {
        localStorage.removeItem('j101_state');
        console.log('All data cleared. Refreshing page...');
        location.reload();
      }
    }

    // Make debug functions available globally for testing
    window.debugLaFavela = debugLaFavela;
    window.fixDataIntegrity = fixDataIntegrity;
    window.resetLaFavela = resetLaFavela;
    window.clearAllData = clearAllData;
  })();
  </script>
</body>
</html>