<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Jager 101  Offline Demo (Stable)</title>
  <style>
    /* ===== Reset & Design Tokens ===== */
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--accent:#1a5c2e;--accent2:#0f3d1f;--fg:#2f3e35;--muted:#5b6d62;--border:#cfd8d3;--bg:#f6f6f6;--chip:#eef6f0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0a0a0a;min-height:100vh;display:flex;justify-content:center;align-items:center}
    .phone{width:390px;max-width:100%;height:100vh;background:#fff;box-shadow:0 0 30px rgba(0,0,0,.4);display:flex;flex-direction:column;overflow:hidden;border-radius:12px}

    /* Screens */
    .screen{display:none;flex-direction:column;height:100%}
    .screen.active{display:flex}

    /* Header */
    .header{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;padding:48px 20px 16px;box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .header h1{font-size:22px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Content */
    .content{flex:1;overflow-y:auto;background:var(--bg);padding-bottom:88px}

    /* Forms */
    .label{font-size:13px;color:var(--muted);margin-bottom:4px}
    .input,.sel,.date,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff;color:var(--fg);transition:.2s}
    .input:focus,.sel:focus,.date:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(26,92,46,.15)}
    .row{display:flex;gap:10px;margin-bottom:12px}

    /* Buttons */
    .btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;line-height:1.2}
    .btn:active{transform:scale(.97)}
    .btn:disabled{background:linear-gradient(135deg,#9fb7a9,#8aa396);cursor:not-allowed;color:#f1f4f2}

    /* Lists */
    .list{padding:15px}
    .card{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 1px 6px rgba(0,0,0,.08);cursor:pointer;transition:.2s;border-left:4px solid transparent}
    .card:hover{box-shadow:0 4px 12px rgba(0,0,0,.12)}
    .card.i{border-left-color:#1a5c2e}.card.c{border-left-color:#2e7d32}.card.h{border-left-color:#66bb6a}
    .card.perfect{background:linear-gradient(135deg,#fffbf0,#fff)}
    .name{font-size:15px;font-weight:800;color:var(--fg);display:flex;align-items:center;gap:6px}
    .loc{font-size:12px;color:#777;margin-top:6px;display:flex;gap:6px;align-items:center}

    /* Nav */
    .nav{position:sticky;bottom:0;background:#fff;border-top:1px solid #e0e0e0;display:flex;justify-content:space-around;padding:8px 0;z-index:3}
    .nav .it{flex:1;text-align:center;padding:6px 0;color:#667085;font-size:12px;cursor:pointer}
    .nav .it.active{color:var(--accent);font-weight:800}
    .icon{width:22px;height:22px;color:currentColor;display:inline-block;vertical-align:middle}
    .icon svg{width:100%;height:100%;display:block;fill:currentColor}
    .nav .icon{display:block;margin:0 auto 4px}

    /* FAB */
    .fab{position:fixed;right:20px;bottom:95px;width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(26,92,46,.4);cursor:pointer;z-index:4}

    /* Tabs */
    .tabs{display:flex;background:#fff;border-bottom:1px solid #e0e0e0}
    .tab{flex:1;padding:12px 0;text-align:center;font-size:13px;color:#666;cursor:pointer;font-weight:700;border-bottom:2px solid transparent}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}

    /* Info */
    .info{padding:15px;background:#fff;border-bottom:1px solid #eee}
    .row2{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f5f5f5}
    .val{font-weight:700;color:var(--fg)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:10px}
    .tile{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:12px;text-align:center;font-size:13px}
    .tile.y{background:#e8f5e9;border-color:var(--accent)}
    .tile.n{background:#ffebee;border-color:#d32f2f}

    /* Summary */
    .sum{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;padding:16px;margin:12px;border-radius:12px;box-shadow:0 4px 12px rgba(26,92,46,.25)}
    .sumg{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .sumi{background:rgba(255,255,255,.1);padding:10px;border-radius:8px;text-align:center}
    .sul{font-size:11px;opacity:.9;margin-bottom:3px}
    .suv{font-size:18px;font-weight:900}

    /* Actions */
    .acts{padding:12px;margin:0 12px 12px;background:#f7f7f7;border-radius:10px}
    .acti{background:#fff;border-left:3px solid var(--accent);padding:8px 10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;font-size:13px}

    /* Filters */
    .filters{padding:12px;background:#fff;border-bottom:1px solid #e0e0e0}
    .chips{display:flex;gap:8px;padding:8px 0;overflow:auto}
    .chip{padding:6px 14px;border:1px solid var(--border);border-radius:20px;background:#f9fbf9;font-size:12px;color:var(--fg);cursor:pointer;transition:.2s;white-space:nowrap}
    .chip:hover,.chip:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(26,92,46,.18);background:var(--chip);border-color:var(--accent);color:var(--accent)}
    .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  </style>
</head>
<body>
  <div class="phone">
    <!-- Login -->
    <div class="screen active" id="login">
      <div style="padding:24px 20px">
        <h1 style="color:var(--accent);margin-bottom:12px;font-size:18px">JÄGERMEISTER  Field Force 101</h1>
        <p style="font-size:12px;color:#777;margin-bottom:20px">Offline demo " LocalStorage " No network requests</p>
        <label class="label">Email</label>
        <input class="input" id="email" value="demo@jager101.com" />
        <label class="label">Password</label>
        <input class="input" id="pass" type="password" value="password" />
        <button class="btn" id="loginBtn"><span class="icon" data-i="user"></span>Sign In</button>
      </div>
    </div>

    <!-- Main -->
    <div class="screen" id="main">
      <div class="header"><h1 id="hdr">VENUES</h1></div>
      <div class="filters" id="filters"></div>
      <div class="content" id="content"></div>
      <button class="fab" id="fab" title="Add"></button>
      <div class="nav" id="nav">
        <div class="it active" data-tab="venues"><span class="icon" data-i="location"></span>Venues</div>
        <div class="it" data-tab="visits"><span class="icon" data-i="clipboard"></span>Visits</div>
        <div class="it" data-tab="statistics"><span class="icon" data-i="chart"></span>Statistics</div>
      </div>
    </div>

    <!-- Detail -->
    <div class="screen" id="detail">
      <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
          <button class="btn" id="backDetail" style="width:auto;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.2)"><span class="icon" data-i="arrowLeft"></span>Back</button>
          <h1 id="dName">Venue Name</h1>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" data-t="info">Information</div>
        <div class="tab" data-t="status">Status</div>
        <div class="tab" data-t="history">History</div>
      </div>
      <div class="content">
        <div id="tab-info">
          <div class="info">
            <div class="row2"><span class="label">Region</span><span class="val" id="dRegion">-</span></div>
            <div class="row2"><span class="label">Area</span><span class="val" id="dArea">-</span></div>
            <div class="row2"><span class="label">Type</span><span class="val" id="dType">-</span></div>
            <div class="row2"><span class="label">Category</span><span class="val" id="dCat">-</span></div>
          </div>
          <div class="info" style="margin-top:10px">
            <div class="row2"><span class="label">Shot Price</span><span class="val" id="dShot">-</span></div>
            <div class="row2"><span class="label">Bottle Price</span><span class="val" id="dBottle">-</span></div>
            <div class="row2"><span class="label">Avg Monthly Sales</span><span class="val" id="dSales">-</span></div>
          </div>
          <div style="padding:15px"><button class="btn" id="openVisit"><span class="icon" data-i="edit"></span>Create Visit Report</button></div>
        </div>
        <div id="tab-status" style="display:none">
          <div class="info" style="border:none">
            <div class="grid" id="dStatus"></div>
          </div>
        </div>
        <div id="tab-history" style="display:none">
          <div class="list" id="dHist"></div>
        </div>
      </div>
    </div>

    <!-- Add Venue -->
    <div class="screen" id="add">
      <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
          <button class="btn" id="backAdd" style="width:auto;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.2)"><span class="icon" data-i="arrowLeft"></span>Back</button>
          <h1>NEW VENUE</h1>
        </div>
      </div>
      <div class="content">
        <div class="info" style="border:none">
          <div class="row" style="flex-direction:column;gap:8px">
            <label class="label">Venue Name</label>
            <input class="input" id="vName" placeholder="e.g. Potato Head Beach Club"/>
            <label class="label">Location</label>
            <select class="sel" id="vLoc"></select>
            <label class="label">Type</label>
            <select class="sel" id="vType"><option value="bar">Bar</option><option value="club">Club</option><option value="restaurant">Restaurant</option></select>
            <label class="label">Category</label>
            <select class="sel" id="vCat"><option value="must-win-image">Must Win Image</option><option value="must-win-commercial">Must Win Commercial</option><option value="high-importance">High Importance</option></select>
            <button class="btn" id="addBtn"><span class="icon" data-i="plus"></span>Add Venue</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Visit Report -->
    <div class="screen" id="visit">
      <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
          <button class="btn" id="backVisit" style="width:auto;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.2)"><span class="icon" data-i="arrowLeft"></span>Back</button>
          <h1>VISIT REPORT</h1>
        </div>
      </div>
      <div class="content">
        <div class="info" style="border:none">
          <div id="visitSel" class="row" style="flex-direction:column;gap:8px">
            <label class="label">Select Venue</label>
            <select class="sel" id="selVenue"><option value="">Select from list...</option></select>
          </div>
          <div class="info" style="margin-top:10px;border:none">
            <div class="row" style="flex-direction:column;gap:8px">
              <label class="label">Shot Price (IDR)</label>
              <input class="input" id="pShot" type="number" inputmode="numeric" placeholder="Current price"/>
              <label class="label">Bottle Price (IDR)</label>
              <input class="input" id="pBottle" type="number" inputmode="numeric" placeholder="Current price"/>
              <label class="label">Avg Monthly Sales (bottles)</label>
              <input class="input" id="pSales" type="number" inputmode="numeric" placeholder="Current sales"/>
            </div>
          </div>
          <div class="info" style="margin-top:10px;border:none">
            <div class="label" style="margin-bottom:8px">Update Venue Status</div>
            <div class="grid" id="toggles"></div>
          </div>
          <div class="info" style="margin-top:10px;border:none">
            <div class="label" style="margin-bottom:8px">Actions Completed During Visit</div>
            <div id="actions" class="list" style="padding:0 0 10px"></div>
          </div>
          <div class="info" style="margin-top:10px;border:none">
            <label class="label">Visit Notes</label>
            <textarea class="input" id="notes" rows="3" placeholder="Additional information..."></textarea>
            <div style="height:10px"></div>
            <button class="btn" id="saveVisit"><span class="icon" data-i="save"></span>Save Visit Report</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // Inline SVG icon set
    const ICONS={
      location:'<svg viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"/></svg>',
      clipboard:'<svg viewBox="0 0 24 24"><path d="M9 2h6a2 2 0 0 1 2 2h2a1 1 0 0 1 1 1v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a1 1 0 0 1 1-1h2a2 2 0 0 1 2-2Zm0 3h6V4H9v1Z"/></svg>',
      chart:'<svg viewBox="0 0 24 24"><path d="M4 20h16v2H2V4h2v16Zm4 0v-7h3v7H8Zm5 0V6h3v14h-3Zm5 0v-11h3v11h-3Z"/></svg>',
      plus:'<svg viewBox="0 0 24 24"><path d="M11 11V4h2v7h7v2h-7v7h-2v-7H4v-2h7Z"/></svg>',
      arrowLeft:'<svg viewBox="0 0 24 24"><path d="M20 11v2H8l5 5-1.4 1.4L4.2 12l7.4-7.4L13 6l-5 5h12Z"/></svg>',
      edit:'<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm18.71-11.04a1.004 1.004 0 0 0 0-1.42l-2.5-2.5a1.004 1.004 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 2-1.66Z"/></svg>',
      calendar:'<svg viewBox="0 0 24 24"><path d="M7 2h2v2h6V2h2v2h3a2 2 0 0 1 2 2v3H2V6a2 2 0 0 1 2-2h3V2Zm15 8v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8h20Z"/></svg>',
      user:'<svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5v3h18v-3c0-2.5-4-5-9-5Z"/></svg>',
      check:'<svg viewBox="0 0 24 24"><path d="M9 16.2 4.8 12l-1.6 1.6L9 19.4l12-12-1.4-1.4Z"/></svg>',
      note:'<svg viewBox="0 0 24 24"><path d="M4 2h12l4 4v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm11 1v5h5"/></svg>',
      star:'<svg viewBox="0 0 24 24"><path d="M12 2 9.2 8H2l5.8 4.2L5.6 20 12 16.4 18.4 20l-2.2-7.8L22 8h-7.2L12 2Z"/></svg>',
      ok:'<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm-1 15-4-4 1.4-1.4L11 14.2l5.6-5.6L18 10Z"/></svg>',
      x:'<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm4.3 13.9-1.4 1.4L12 13.4l-2.9 2.9-1.4-1.4 2.9-2.9-2.9-2.9 1.4-1.4L12 10.6l2.9-2.9 1.4 1.4-2.9 2.9Z"/></svg>',
      pie:'<svg viewBox="0 0 24 24"><path d="M11 2a10 10 0 1 0 10 10h-8a2 2 0 0 1-2-2V2Z"/><path d="M13 2v8h8A10 10 0 0 0 13 2Z"/></svg>',
      save:'<svg viewBox="0 0 24 24"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4Zm-3 0v6H6V3h8Z"/></svg>'
    };

    // Shortcuts
    const $=id=>document.getElementById(id);
    const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const esc=s=>String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const fmtIDR=new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0});
    const fmtInt=new Intl.NumberFormat('id-ID');

    // State
    let user=null; let venues=[], visits=[]; let tab='venues'; let current=null; let fromDetail=false;

    // Data helpers
    const locOptions=[
      {v:'',l:'All Locations'},
      {v:'bali|all',l:'Bali - All areas'},{v:'bali|Seminyak',l:'Bali - Seminyak'},{v:'bali|Canggu',l:'Bali - Canggu'},{v:'bali|Uluwatu',l:'Bali - Uluwatu'},
      {v:'west-java|all',l:'West Java - All areas'},{v:'west-java|Jakarta',l:'West Java - Jakarta'},{v:'west-java|Bandung',l:'West Java - Bandung'},
      {v:'east-java|all',l:'East Java - All areas'},{v:'east-java|Surabaya',l:'East Java - Surabaya'},{v:'east-java|Malang',l:'East Java - Malang'}
    ];
    const perfect=v=>v.lightVisibility&&v.coolingDevice&&v.standardPOSM&&v.correctMenu&&v.promo&&v.iceColdServe&&v.staffTraining;
    const dateLocal=iso=>{const [y,m,d]=iso.split('-').map(Number);return new Date(y,m-1,d,12)};

    // Storage
    function save(){ try{localStorage.setItem('j101_state',JSON.stringify({venues,visits}))}catch(e){} }
    function load(){ try{const s=JSON.parse(localStorage.getItem('j101_state')); if(s){ venues=s.venues||[]; visits=(s.visits||[]).map(v=>({...v,dateObj:v.dateObj?new Date(v.dateObj):v.date?dateLocal(v.date):new Date()})); return true; }}catch(e){} return false; }

    // Seed data
    function seed(){ venues=[
      { id:1,name:'Potato Head Beach Club',region:'bali',area:'Seminyak',category:'must-win-image',venueType:'club',shotPrice:125000,bottlePrice:2500000,avgMonthlySales:45,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:2,name:'La Favela',region:'bali',area:'Seminyak',category:'must-win-commercial',venueType:'bar',shotPrice:95000,bottlePrice:2200000,avgMonthlySales:38,contract:true,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:false,promo:false,iceColdServe:true,staffTraining:true },
      { id:3,name:'Finns Beach Club',region:'bali',area:'Canggu',category:'must-win-image',venueType:'club',shotPrice:120000,bottlePrice:2450000,avgMonthlySales:42,contract:false,customBranding:false,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:4,name:'Old Mans',region:'bali',area:'Canggu',category:'must-win-commercial',venueType:'bar',shotPrice:85000,bottlePrice:1950000,avgMonthlySales:55,contract:true,customBranding:true,lightVisibility:false,coolingDevice:true,standardPOSM:false,correctMenu:false,promo:true,iceColdServe:false,staffTraining:false },
      { id:5,name:'Rock Bar',region:'bali',area:'Uluwatu',category:'must-win-image',venueType:'bar',shotPrice:135000,bottlePrice:2800000,avgMonthlySales:35,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:6,name:'Dragonfly',region:'west-java',area:'Jakarta',category:'must-win-image',venueType:'club',shotPrice:125000,bottlePrice:2600000,avgMonthlySales:65,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:7,name:'Noah Barn',region:'west-java',area:'Bandung',category:'must-win-commercial',venueType:'bar',shotPrice:75000,bottlePrice:1800000,avgMonthlySales:22,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true },
      { id:8,name:'Colors Pub',region:'east-java',area:'Surabaya',category:'must-win-commercial',venueType:'bar',shotPrice:85000,bottlePrice:2000000,avgMonthlySales:35,contract:true,customBranding:true,lightVisibility:true,coolingDevice:true,standardPOSM:true,correctMenu:true,promo:true,iceColdServe:true,staffTraining:true }
    ];
    visits=[
      { id:1,venueId:1,date:'2024-12-20',dateObj:dateLocal('2024-12-20'),user:'John Smith',actions:['Staff training done','Standard POSM placed','Perfect Outlet status achieved'],notes:'Year-end campaign ready.' },
      { id:2,venueId:6,date:'2024-12-20',dateObj:dateLocal('2024-12-20'),user:'Sarah Johnson',actions:['Contract signed','Custom branding installed','Perfect Outlet status achieved'],notes:'Premium Jakarta placement.' },
      { id:3,venueId:4,date:'2024-12-19',dateObj:dateLocal('2024-12-19'),user:'John Smith',actions:['Light visibility placed','Staff training done'],notes:'Improve POSM next time.' },
      { id:4,venueId:3,date:'2024-12-18',dateObj:dateLocal('2024-12-18'),user:'John Smith',actions:['Contract negotiation','Perfect Outlet status achieved'],notes:'Contract pending approval.' }
    ]; }

    // Screens & Tabs
    function show(id){ qsa('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); toggleFab(); if(id==='visit' && !fromDetail){ fillVisitSelect(); buildToggles(); buildActions(); } }
    function toggleFab(){ const on=$('main').classList.contains('active') && tab!=='statistics'; $('fab').style.display=on?'flex':'none'; }
    function setTab(t){ tab=t; qsa('.nav .it').forEach(i=>i.classList.toggle('active',i.dataset.tab===t)); const h=$('hdr'); if(t==='venues'){ h.textContent='VENUES'; renderVenueFilters(); renderVenues(); } else if(t==='visits'){ h.textContent='VISIT REPORTS'; renderVisitFilters(); renderVisits(); } else { h.textContent='STATISTICS'; renderStatFilters(); renderStats(); } toggleFab(); }

    // Venues list
    function renderVenueFilters(){ const f=$('filters'); const opts=locOptions.map(o=>`<option value="${o.v}">${o.l}</option>`).join(''); f.innerHTML=`
      <div class="row"><select class="sel" id="fLoc">${opts}</select></div>
      <div class="row"><select class="sel" id="fCat"><option value="">All Categories</option><option value="must-win-image">Must Win Image</option><option value="must-win-commercial">Must Win Commercial</option><option value="high-importance">High Importance</option></select>
      <select class="sel" id="fType"><option value="">All Types</option><option value="bar">Bar</option><option value="club">Club</option><option value="restaurant">Restaurant</option></select></div>
      <div class="row"><input class="input" id="fQuery" placeholder="Search by venue name..."/></div>`;
      ['fLoc','fCat','fType'].forEach(id=>$(id).addEventListener('change',filterVenues)); $('fQuery').addEventListener('input',filterVenues);
    }
    function filterVenues(){ const loc=$('fLoc').value,cat=$('fCat').value,typ=$('fType').value,q=($('fQuery').value||'').toLowerCase(); let arr=venues.filter(v=>v.name.toLowerCase().includes(q)); if(loc){ const [r,a]=loc.split('|'); arr=arr.filter(v=>a==='all'?v.region===r:(v.region===r&&v.area===a)); } if(cat) arr=arr.filter(v=>v.category===cat); if(typ) arr=arr.filter(v=>v.venueType===typ); renderVenues(arr); }
    function renderVenues(arr){ const c=$('content'); const data=arr||venues; if(!data.length){ c.innerHTML='<p style="text-align:center;color:#999;padding:40px">No venues</p>'; return;} let html='<div class="list">'; data.forEach(v=>{ const k=v.category==='must-win-image'?'i':v.category==='must-win-commercial'?'c':'h'; html+=`<div class="card ${k}${perfect(v)?' perfect':''}" data-id="${v.id}">`+
      `<div class="name">${perfect(v)?`<span class="icon">${ICONS.star}</span>`:''}${esc(v.name)}</div>`+
      `<div class="loc"><span class="icon">${ICONS.location}</span>${esc(v.area)}, ${esc(v.region.replace('-', ' ').toUpperCase())}</div>`+
      `</div>`; }); html+='</div>'; c.innerHTML=html; qsa('.card',c).forEach(el=>el.addEventListener('click',()=>openDetail(Number(el.dataset.id)))); }

    // Visits
    function renderVisitFilters(){ const f=$('filters'); const t=new Date(),m=new Date(); m.setMonth(t.getMonth()-1); const to=d=>d.toISOString().split('T')[0]; f.innerHTML=`
      <div class="row"><input type="date" class="date" id="dFrom" value="${to(m)}"><input type="date" class="date" id="dTo" value="${to(t)}"></div>
      <div class="chips"><button class="chip" data-p="week">Week</button><button class="chip active" data-p="month">Month</button><button class="chip" data-p="quarter">Quarter</button><button class="chip" data-p="year">Year</button><button class="chip" data-p="all">All</button></div>`;
      $('dFrom').addEventListener('change',renderVisits); $('dTo').addEventListener('change',renderVisits); qsa('.chip',f).forEach(b=>b.addEventListener('click',()=>setPeriod(b.dataset.p,b)));
    }
    function setPeriod(p,btn){ qsa('.chip').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); const t=new Date(); let f=new Date(); if(p==='week') f.setDate(t.getDate()-7); else if(p==='month') f.setMonth(t.getMonth()-1); else if(p==='quarter') f.setMonth(t.getMonth()-3); else if(p==='year') f.setFullYear(t.getFullYear()-1); else f=new Date('2024-01-01'); $('dFrom').value=f.toISOString().split('T')[0]; $('dTo').value=t.toISOString().split('T')[0]; renderVisits(); }
    function renderVisits(){ const from=new Date($('dFrom').value), to=new Date($('dTo').value); to.setHours(23,59,59,999); const list=visits.filter(v=>v.dateObj>=from&&v.dateObj<=to); const c=$('content'); const s={total:list.length,venues:new Set(list.map(v=>v.venueId)).size,contracts:list.filter(v=>v.actions?.some(a=>/Contract/i.test(a))).length,trainings:list.filter(v=>v.actions?.some(a=>/training/i.test(a))).length}; let html=`<div class="sum"><div class="sumg">`+
      `<div class="sumi"><div class="sul">Total Visits</div><div class="suv">${s.total}</div></div>`+
      `<div class="sumi"><div class="sul">Unique Venues</div><div class="suv">${s.venues}</div></div>`+
      `<div class="sumi"><div class="sul">Contracts Signed</div><div class="suv">${s.contracts}</div></div>`+
      `<div class="sumi"><div class="sul">Staff Trainings</div><div class="suv">${s.trainings}</div></div>`+
      `</div></div><div class="acts"><div class="acti"><span>Contracts Signed</span><strong style="color:var(--accent)">${s.contracts}</strong></div><div class="acti"><span>Staff Trainings</span><strong style="color:var(--accent)">${s.trainings}</strong></div><div class="acti"><span>Promos Started</span><strong style="color:var(--accent)">${list.filter(v=>v.actions?.some(a=>/Promo/i.test(a))).length}</strong></div></div><div class="list">`;
      list.forEach(v=>{ const ven=venues.find(x=>x.id===v.venueId); if(!ven) return; html+=`<div class="card" data-id="${ven.id}">`+
        `<div style="font-size:11px;color:#999;display:flex;gap:6px;align-items:center"><span class="icon">${ICONS.calendar}</span>${v.date}</div>`+
        `<div class="name">${esc(ven.name)}</div>`+
        `<div class="loc"><span class="icon">${ICONS.location}</span>${esc(ven.area)}, ${esc(ven.region.toUpperCase())}</div>`+
        `<div style="margin-top:8px;font-size:13px;color:#666">${(v.actions||[]).map(a=>`<span class="icon">${ICONS.check}</span> ${esc(a)}`).join('<br>')}</div>`+
        (v.notes? `<div style="margin-top:8px;padding:8px;background:#f5f5f5;border-radius:6px;font-size:12px"><span class="icon">${ICONS.note}</span> ${esc(v.notes)}</div>`:'')+
      `</div>`; }); html+='</div>'; c.innerHTML=html; qsa('.card',c).forEach(el=>el.addEventListener('click',()=>openDetail(Number(el.dataset.id)))); }

    // Statistics
    function renderStatFilters(){ const f=$('filters'); const opts=locOptions.map(o=>`<option value="${o.v}">${o.l}</option>`).join(''); f.innerHTML=`
      <div class="row"><select class="sel" id="sLoc">${opts}</select></div>
      <div class="row"><select class="sel" id="sCat"><option value="">All Categories</option><option value="must-win-image">Must Win Image</option><option value="must-win-commercial">Must Win Commercial</option><option value="high-importance">High Importance</option></select>
      <select class="sel" id="sPerf"><option value="">All Outlets</option><option value="perfect">Perfect Only P</option><option value="not">Non-Perfect</option></select></div>`;
      ['sLoc','sCat','sPerf'].forEach(id=>$(id).addEventListener('change',renderStats));
    }
    function renderStats(){ const c=$('content'); const loc=$('sLoc')?.value||'',cat=$('sCat')?.value||'',pf=$('sPerf')?.value||''; let arr=venues.slice(); if(loc){ const [r,a]=loc.split('|'); arr=arr.filter(v=>a==='all'?v.region===r:(v.region===r&&v.area===a)); } if(cat) arr=arr.filter(v=>v.category===cat); if(pf==='perfect') arr=arr.filter(perfect); else if(pf==='not') arr=arr.filter(v=>!perfect(v)); const total=arr.length; if(!total){ c.innerHTML='<p style="text-align:center;color:#999;padding:40px">No venues match the selected filters</p>'; return; } const p=arr.filter(perfect).length; const avgShot=Math.round(arr.reduce((s,v)=>s+(v.shotPrice||0),0)/total); const avgBottle=Math.round(arr.reduce((s,v)=>s+(v.bottlePrice||0),0)/total); let html=`<div class="sum"><div class="sumg">`+
        `<div class="sumi"><div class="sul">Perfect Outlets</div><div class="suv">${p}</div></div>`+
        `<div class="sumi"><div class="sul">Total Venues</div><div class="suv">${total}</div></div>`+
        `<div class="sumi"><div class="sul">Avg Shot Price</div><div class="suv">${fmtIDR.format(avgShot)}</div></div>`+
        `<div class="sumi"><div class="sul">Avg Bottle Price</div><div class="suv">${fmtIDR.format(avgBottle)}</div></div>`+
      `</div></div>`; const k=[ ['Contracts','contract'],['Custom Branding','customBranding'],['Light Visibility','lightVisibility'],['Cooling Device','coolingDevice'],['Standard POSM','standardPOSM'],['Correct Menu','correctMenu'],['Promo Active','promo'],['Ice-cold Serve','iceColdServe'],['Staff Training','staffTraining'] ]; html+='<div class="list">'; k.forEach(([lab,key])=>{ const val=arr.filter(v=>v[key]).length; const perc=Math.round((val/total)*100); const bg=perc>=80?'#e8f5e9':perc>=50?'#fff3e0':'#ffebee'; html+=`<div class="card" style="background:${bg}"><div class="row2"><span class="label">${lab}</span><span class="val">${perc}%</span></div><div class="label">${val}/${total}</div></div>`; }); html+='</div>'; c.innerHTML=html; }

    // Detail
    function openDetail(id){ current=id; const v=venues.find(x=>x.id===id); if(!v) return; $('dName').textContent=v.name; $('dRegion').textContent=v.region; $('dArea').textContent=v.area; $('dType').textContent=v.venueType; $('dCat').textContent=v.category; $('dShot').textContent=v.shotPrice?fmtIDR.format(v.shotPrice):'-'; $('dBottle').textContent=v.bottlePrice?fmtIDR.format(v.bottlePrice):'-'; $('dSales').textContent=v.avgMonthlySales?fmtInt.format(v.avgMonthlySales)+' bottles':'-'; const pairs=[ ['Contract',v.contract],['Custom Branding',v.customBranding],['Light Visibility',v.lightVisibility],['Cooling Device',v.coolingDevice],['Standard POSM',v.standardPOSM],['Correct Menu',v.correctMenu],['Promo Active',v.promo],['Ice-cold Serve',v.iceColdServe],['Staff Training',v.staffTraining] ]; $('dStatus').innerHTML=pairs.map(([l,val])=>`<div class="tile ${val?'y':'n'}">${val?`<span class="icon">${ICONS.ok}</span>`:`<span class="icon">${ICONS.x}</span>`} ${l}</div>`).join(''); const hist=visits.filter(r=>r.venueId===id).sort((a,b)=>b.dateObj-a.dateObj); $('dHist').innerHTML= hist.length? hist.map(h=>`<div class="card">`+
        `<div style="font-size:11px;color:#999;display:flex;gap:6px;align-items:center"><span class="icon">${ICONS.calendar}</span>${h.date}</div>`+
        `<div class="loc" style="margin-top:4px"><span class="icon">${ICONS.user}</span>${esc(h.user)}</div>`+
        (h.actions?.length? `<div style="margin-top:6px;font-size:13px;color:#666">${h.actions.map(a=>`<span class="icon">${ICONS.check}</span> ${esc(a)}`).join('<br>')}</div>`:'')+
        (h.notes? `<div style="margin-top:8px;padding:8px;background:#f5f5f5;border-radius:6px;font-size:12px"><span class="icon">${ICONS.note}</span> ${esc(h.notes)}</div>`:'')+
      `</div>`).join('') : '<p style="padding:12px;color:#777">No history yet</p>'; qsa('.tab').forEach(t=>t.classList.remove('active')); qsa('[id^=tab-]').forEach(e=>e.style.display='none'); qsa('.tab')[0].classList.add('active'); $('tab-info').style.display='block'; show('detail'); }
    qsa('.tab').forEach(t=>t.addEventListener('click',()=>{ qsa('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); qsa('[id^=tab-]').forEach(e=>e.style.display='none'); $(`tab-${t.dataset.t}`).style.display='block'; }));

    // Visit helpers
    function fillVisitSelect(){ const s=$('selVenue'); s.innerHTML='<option value="">Select from list...</option>'+venues.map(v=>`<option value="${v.id}">${esc(v.name)}</option>`).join(''); }
    function buildToggles(){ const keys=['contract','customBranding','lightVisibility','coolingDevice','standardPOSM','correctMenu','promo','iceColdServe','staffTraining']; $('toggles').innerHTML=keys.map(k=>`<div class="tile" data-k="${k}" style="cursor:pointer;user-select:none">${k.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase())}</div>`).join(''); qsa('#toggles .tile').forEach(t=>t.addEventListener('click',()=>t.classList.toggle('y'))); }
    function buildActions(){ const a=['Contract signed','Custom branding installed','Light visibility placed','Cooling device installed','Standard POSM placed','Correct menu reprinted','Promo started','Ice-cold serve done','Staff training done']; $('actions').innerHTML=a.map(x=>`<div class="card acti" data-a="${x}" style="cursor:pointer">${x}<span class="icon">${ICONS.check}</span></div>`).join(''); qsa('#actions .acti').forEach(i=>i.addEventListener('click',()=>i.classList.toggle('active'))); }

    // Add / Save
    function addVenue(){ const name=$('vName').value.trim(); const loc=$('vLoc').value; if(!name||!loc){ alert('Please enter name and location'); return;} const [region,area]=loc.split('|'); const id=venues.reduce((m,v)=>Math.max(m,v.id),0)+1; const v={ id,name,region,area,category:$('vCat').value,venueType:$('vType').value,shotPrice:0,bottlePrice:0,avgMonthlySales:0,contract:false,customBranding:false,lightVisibility:false,coolingDevice:false,standardPOSM:false,correctMenu:false,promo:false,iceColdServe:false,staffTraining:false }; venues.push(v); save(); setTab('venues'); }
    function saveVisit(){ const vid=Number(($('selVenue').value||current)||0); if(!vid){ alert('Choose a venue'); return;} const v=venues.find(x=>x.id===vid); if(!v){ alert('Venue not found'); return; } const shot=Number($('pShot').value)||null, bottle=Number($('pBottle').value)||null, sales=Number($('pSales').value)||null; if(shot) v.shotPrice=shot; if(bottle) v.bottlePrice=bottle; if(sales) v.avgMonthlySales=sales; qsa('#toggles .tile').forEach(t=>{ const k=t.getAttribute('data-k'); if(t.classList.contains('y')) v[k]=true; }); const acts=qsa('#actions .acti.active').map(i=>i.getAttribute('data-a')); const notes=$('notes').value.trim(); const now=new Date(); const rec={ id:(visits.reduce((m,r)=>Math.max(m,r.id),0)+1), venueId:vid, date:now.toISOString().split('T')[0], dateObj:new Date(now.getFullYear(),now.getMonth(),now.getDate(),12), user:user?.name||'Demo User', actions:acts, notes }; visits.unshift(rec); save(); alert('Visit saved'); if(fromDetail){ openDetail(vid); } else { setTab('visits'); } }

    // Nav & events
    function setupNav(){ qsa('#nav .it').forEach(n=>n.addEventListener('click',()=>setTab(n.dataset.tab))); $('fab').addEventListener('click',()=>{ if(tab==='venues'){ $('vLoc').innerHTML=locOptions.filter(o=>o.v).map(o=>`<option value="${o.v}">${o.l}</option>`).join(''); show('add'); } else if(tab==='visits'){ fromDetail=false; show('visit'); fillVisitSelect(); buildToggles(); buildActions(); } }); $('backDetail').addEventListener('click',()=>show('main')); $('backAdd').addEventListener('click',()=>show('main')); $('backVisit').addEventListener('click',()=>{ if(fromDetail&&current){ openDetail(current); } else { show('main'); } }); $('openVisit').addEventListener('click',()=>{ fromDetail=true; show('visit'); $('visitSel').style.display='none'; $('selVenue').innerHTML=`<option value="${current}">Current: ${esc(venues.find(v=>v.id===current).name)}</option>`; buildToggles(); buildActions(); }); $('addBtn').addEventListener('click',addVenue); $('saveVisit').addEventListener('click',saveVisit); }

    // Icons injection (safe, after DOM is ready)
    function initIcons(){ qsa('[data-i]').forEach(el=>{ el.innerHTML=ICONS[el.getAttribute('data-i')]||''; }); const f=$('fab'); if(f) f.innerHTML=ICONS.plus; }

    // Login
    function login(){ user={name:'Demo User',email:($('email').value||'demo@jager101.com').trim()}; const had=load(); if(!had) seed(); show('main'); setTab('venues'); }

    // Init
    function init(){ setupNav(); initIcons(); $('loginBtn').addEventListener('click',login); $('pass').addEventListener('keydown',e=>{ if(e.key==='Enter') login(); }); }
    init();

    // Optional: developer smoke-tests (disabled by default to avoid auto navigation)
    function runTests(){ try{
      show('login'); login(); console.assert($('main').classList.contains('active'),'Login opens main');
      setTab('visits'); console.assert($('content').innerHTML.includes('Total Visits'),'Visits summary');
      setTab('statistics'); console.assert($('content').innerHTML.includes('Perfect Outlets'),'Stats render');
      setTab('venues'); const before=venues.length; $('fab').click(); $('vName').value='Test Venue'; const loc=$('vLoc'); if(loc.options.length){ loc.value=loc.options[0].value;} $('addBtn').click(); console.assert(venues.length===before+1,'Venue added');
    }catch(e){ console.error('[tests failed]',e); }
    }
    // runTests();
  })();
  </script>
</body>
</html>